===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\main.dart ===== 
import 'dart:ui' as ui;

import 'package:flutter/material.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:get/get.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:intl/date_symbol_data_local.dart';

import 'core/security/simple_encryption.dart';
import 'features/expense/presentation/controllers/expense_controller.dart';
import 'features/expense/presentation/controllers/budget_controller.dart';
import 'features/alerts/presentation/controllers/alert_controller.dart';
import 'features/backup/presentation/controllers/backup_controller.dart';
import 'features/search/presentation/controllers/expense_search_controller.dart';
import 'features/expense/presentation/pages/home_page.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  print('ğŸš€ Finance App - Starting...');

  try {
    // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    await initializeDateFormatting('ar_EG', null);
    print('âœ… Dates initialized');

    // 2. âœ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ´ÙÙŠØ±
    await SimpleEncryption.initialize();

    // âœ… FIXED: Use .status instead of .encryptionStatus
    final encryptionStatus = SimpleEncryption.status;
    print('âœ… Encryption ready: $encryptionStatus');

    // 3. ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    runApp(const MyApp());

    print('âœ… App started successfully');
  } catch (e) {
    print('âŒ App startup error: $e');
    runApp(const EmergencyApp());
  }
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    // Ø­Ù‚Ù† Ø§Ù„Ù…ØªØ­ÙƒÙ…Ø§Øª
    Get.put(ExpenseController());
    Get.put(BudgetController());
    Get.put(AlertController());
    Get.put(BackupController());
    Get.put(ExpenseSearchController(), tag: ExpenseSearchController.TAG);

    return GetMaterialApp(
      title: 'Ù…Ø§Ù„ÙŠ - Finance App',
      debugShowCheckedModeBanner: false,

      // ============ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„ØªÙˆØ·ÙŠÙ† ============
      locale: const ui.Locale('ar', 'EG'), // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      fallbackLocale: const ui.Locale('ar', 'EG'), // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      localizationsDelegates: const [
        GlobalMaterialLocalizations.delegate,
        GlobalWidgetsLocalizations.delegate,
        GlobalCupertinoLocalizations.delegate,
      ],
      supportedLocales: const [
        ui.Locale('ar', 'EG'), // Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - Ù…ØµØ±
        ui.Locale('en', 'US'), // Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© - Ø£Ù…Ø±ÙŠÙƒØ§
      ],
      // ==============================================

      themeMode: ThemeMode.system,

      // âœ… Light mode :
      theme: ThemeData.light().copyWith(
        primaryColor: const Color(0xFF1565C0), // âœ… Darker primary blue
        colorScheme: ColorScheme.light(
          primary: const Color(0xFF1565C0), // âœ… Dark blue
          secondary: const Color(0xFF42A5F5), // âœ… Lighter blue
          background: Colors.grey[50]!,
          surface: Colors.white,
          onPrimary: Colors.white, // âœ… White text on primary
        ),
        textTheme: GoogleFonts.cairoTextTheme(
          ThemeData.light().textTheme,
        ),
        appBarTheme: AppBarTheme(
          backgroundColor: const Color(0xFF1565C0), // âœ… Dark blue
          foregroundColor: Colors.white, // âœ… White text
          elevation: 4,
          centerTitle: true,
          titleTextStyle: GoogleFonts.cairo(
            fontSize: 18,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
          iconTheme: const IconThemeData(color: Colors.white),
        ),
        inputDecorationTheme: InputDecorationTheme(
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: Colors.grey[400]!),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: const BorderSide(color: Color(0xFF1565C0)),
          ),
          filled: true,
          fillColor: Colors.grey[50],
          contentPadding: const EdgeInsets.symmetric(
            horizontal: 16,
            vertical: 14,
          ),
          hintStyle: TextStyle(color: Colors.grey[600]),
          labelStyle: TextStyle(color: Colors.grey[700]),
        ),
        elevatedButtonTheme: ElevatedButtonThemeData(
          style: ElevatedButton.styleFrom(
            backgroundColor: const Color(0xFF1565C0),
            foregroundColor: Colors.white,
            elevation: 4,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12),
            ),
            padding: const EdgeInsets.symmetric(
              horizontal: 24,
              vertical: 14,
            ),
            textStyle: GoogleFonts.cairo(
              fontSize: 16,
              fontWeight: FontWeight.w600,
            ),
          ),
        ),
      ),

      // Dark mode :
      darkTheme: ThemeData.dark().copyWith(
        primaryColor: const Color(0xFF0D47A1), // âœ… Very dark blue
        colorScheme: ColorScheme.dark(
          primary: const Color(0xFF0D47A1),
          secondary: const Color(0xFF64B5F6),
          background: const Color(0xFF121212),
          surface: const Color(0xFF1E1E1E),
          onPrimary: Colors.white,
        ),
        textTheme: GoogleFonts.cairoTextTheme(
          ThemeData.dark().textTheme,
        ),
        appBarTheme: AppBarTheme(
          backgroundColor: const Color(0xFF0D47A1), // âœ… Very dark blue
          foregroundColor: Colors.white,
          elevation: 4,
          centerTitle: true,
          titleTextStyle: GoogleFonts.cairo(
            fontSize: 18,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
          iconTheme: const IconThemeData(color: Colors.blue),
        ),
        inputDecorationTheme: InputDecorationTheme(
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: Colors.grey[700]!),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: const BorderSide(color: Color(0xFF64B5F6)),
          ),
          filled: true,
          fillColor: const Color(0xFF2D2D2D),
          hintStyle: TextStyle(color: Colors.grey[400]),
          labelStyle: TextStyle(color: Colors.grey[300]),
        ),
        elevatedButtonTheme: ElevatedButtonThemeData(
          style: ElevatedButton.styleFrom(
            backgroundColor: const Color(0xFF0D47A1),
            foregroundColor: Colors.white,
            elevation: 4,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12),
            ),
            padding: const EdgeInsets.symmetric(
              horizontal: 24,
              vertical: 14,
            ),
            textStyle: GoogleFonts.cairo(
              fontSize: 16,
              fontWeight: FontWeight.w600,
            ),
          ),
        ),
      ),

      home: HomePage(),
    );
  }
}

//  Emeregency Mode :
class EmergencyApp extends StatelessWidget {
  const EmergencyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      home: Scaffold(
        body: Center(
          child: Text('Finance App - Emergency Mode'),
        ),
      ),
    );
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\core\config\app_config.dart ===== 
import 'dart:ui' as ui;

class AppConfig {
  // App Information
  static const String appName = 'Ù…Ø§Ù„ÙŠ';
  static const String appNameEn = 'Finance App';
  static const String version = '1.1.0';
  static const int buildNumber = 1;

  // Localization
  static const ui.Locale defaultLocale = ui.Locale('ar', 'EG');
  static const ui.Locale fallbackLocale = ui.Locale('ar', 'EG');
  static const List<ui.Locale> supportedLocales = [
    ui.Locale('ar', 'EG'),
    ui.Locale('en', 'US'),
  ];

  // Currency
  static const String currencySymbol = 'Ø¬.Ù…';
  static const String currencyCode = 'EGP';
  static const int decimalPlaces = 2;

  // Security
  static const String encryptionKeyStorageKey = 'finance_app_key';
  static const int encryptionKeyLength = 32; // 256-bit for AES

  // Storage Keys
  static const String expensesKey = 'expenses';
  static const String monthlyBudgetKey = 'monthlyBudget';
  static const String categoryBudgetsKey = 'categoryBudgets';
  static const String lastBackupDateKey = 'lastBackupDate';

  // Default Values
  static const double defaultMonthlyBudget = 0.0;
  static const double largeExpenseThreshold = 500.0;
  static const double budgetAlertThreshold = 80.0; // Percentage

  // Date & Time
  static const String dateFormat = 'yyyy/MM/dd';
  static const String dateTimeFormat = 'yyyy/MM/dd HH:mm';
  static const String backupDateFormat = 'yyyyMMdd_HHmmss';

  // File Export
  static const String csvExportPrefix = 'Ù…Ø§Ù„ÙŠ_ØªØµØ¯ÙŠØ±_';
  static const String jsonExportPrefix = 'Ù…Ø§Ù„ÙŠ_ØªØµØ¯ÙŠØ±_';
  static const String backupFilePrefix = 'finance_backup_';

  // UI Constants
  static const double defaultBorderRadius = 12.0;
  static const double defaultPadding = 16.0;
  static const double cardElevation = 2.0;

  // Chart Configuration
  static const int chartMonthsToShow = 6;
  static const double chartBarWidth = 16.0;
  static const int chartMaxAmountDivisions = 5;

  // Search & Filter
  static const double defaultMinAmount = 0.0;
  static const double defaultMaxAmount = 1000000.0;
  static const int searchResultsLimit = 50;

  // Backup & Export
  static const int backupKeepDays = 7;
  static const int maxBackupFiles = 10;

  // Alerts
  static const bool defaultBudgetAlerts = true;
  static const bool defaultLargeExpenseAlerts = true;
  static const bool defaultDailySummary = false;

  // Categories (Arabic)
  static const List<String> expenseCategories = [
    'Ø·Ø¹Ø§Ù…',
    'Ù…ÙˆØ§ØµÙ„Ø§Øª',
    'ØªØ³ÙˆÙ‚',
    'ØªØ±ÙÙŠÙ‡',
    'ØµØ­Ø©',
    'ØªØ¹Ù„ÙŠÙ…',
    'Ø³ÙƒÙ†',
    'ÙÙˆØ§ØªÙŠØ±',
    'Ù…Ø±ØªØ¨',
    'Ø§Ø³ØªØ«Ù…Ø§Ø±',
    'Ù‡Ø¯Ø§ÙŠØ§',
    'Ø£Ø®Ø±Ù‰'
  ];

  static const List<String> budgetCategories = [
    'Ø·Ø¹Ø§Ù…',
    'Ù…ÙˆØ§ØµÙ„Ø§Øª',
    'ØªØ³ÙˆÙ‚',
    'ØªØ±ÙÙŠÙ‡',
    'ØµØ­Ø©',
    'ØªØ¹Ù„ÙŠÙ…',
    'Ø³ÙƒÙ†',
    'ÙÙˆØ§ØªÙŠØ±'
  ];

  // Payment Methods (Arabic)
  static const List<String> paymentMethods = [
    'Ù†Ù‚Ø¯ÙŠ',
    'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†',
    'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ',
    'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©',
    'Ø´ÙŠÙƒ'
  ];

  // Theme Colors
  static const Map<String, dynamic> lightThemeColors = {
    'primary': 0xFF2196F3,
    'secondary': 0xFF03A9F4,
    'background': 0xFFFAFAFA,
    'surface': 0xFFFFFFFF,
    'error': 0xFFF44336,
    'success': 0xFF4CAF50,
    'warning': 0xFFFF9800,
    'income': 0xFF4CAF50,
    'expense': 0xFFF44336,
  };

  static const Map<String, dynamic> darkThemeColors = {
    'primary': 0xFF64B5F6,
    'secondary': 0xFF4FC3F7,
    'background': 0xFF121212,
    'surface': 0xFF1E1E1E,
    'error': 0xFFCF6679,
    'success': 0xFF81C784,
    'warning': 0xFFFFB74D,
    'income': 0xFF81C784,
    'expense': 0xFFCF6679,
  };

  // App URLs (Update these for production)
  static const String privacyPolicyUrl = 'https://example.com/privacy';
  static const String termsOfServiceUrl = 'https://example.com/terms';
  static const String supportEmail = 'support@example.com';
  static const String websiteUrl = 'https://example.com';

  // Feature Flags (Enable/Disable features)
  static const bool enableBackup = true;
  static const bool enableExport = true;
  static const bool enableAlerts = true;
  static const bool enableAnalytics = true;
  static const bool enableDarkMode = true;
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\core\constants\app_colors.dart ===== 
import 'package:flutter/material.dart';

class AppColors {
  static const Color primary = Color(0xFF2196F3);
  static const Color secondary = Color(0xFF03A9F4);
  static const Color success = Color(0xFF4CAF50);
  static const Color warning = Color(0xFFFF9800);
  static const Color danger = Color(0xFFF44336);
  static const Color income = Color(0xFF4CAF50);
  static const Color expense = Color(0xFFF44336);
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\core\constants\app_texts.dart ===== 
class AppTexts {
  // General
  static const String appName = 'Ù…Ø§Ù„ÙŠ';
  static const String currency = 'Ø¬.Ù…';

  // Buttons
  static const String save = 'Ø­ÙØ¸';
  static const String cancel = 'Ø¥Ù„ØºØ§Ø¡';
  static const String delete = 'Ø­Ø°Ù';
  static const String edit = 'ØªØ¹Ø¯ÙŠÙ„';

  // Messages
  static const String confirmDelete = 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ';
  static const String deleteSuccess = 'ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­';
  static const String saveSuccess = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­';
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\core\models\enums.dart ===== 
enum ExpenseCategory {
  food('Ø·Ø¹Ø§Ù…'),
  transportation('Ù…ÙˆØ§ØµÙ„Ø§Øª'),
  shopping('ØªØ³ÙˆÙ‚'),
  entertainment('ØªØ±ÙÙŠÙ‡'),
  health('ØµØ­Ø©'),
  education('ØªØ¹Ù„ÙŠÙ…'),
  housing('Ø³ÙƒÙ†'),
  bills('ÙÙˆØ§ØªÙŠØ±'),
  salary('Ù…Ø±ØªØ¨'),
  investment('Ø§Ø³ØªØ«Ù…Ø§Ø±'),
  gifts('Ù‡Ø¯Ø§ÙŠØ§'),
  other('Ø£Ø®Ø±Ù‰');

  final String arabicName;
  const ExpenseCategory(this.arabicName);

  static ExpenseCategory fromString(String name) {
    return ExpenseCategory.values.firstWhere(
      (e) => e.arabicName == name,
      orElse: () => ExpenseCategory.other,
    );
  }
}

enum PaymentMethod {
  cash('Ù†Ù‚Ø¯ÙŠ'),
  creditCard('Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†'),
  bankTransfer('ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ'),
  wallet('Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©'),
  check('Ø´ÙŠÙƒ');

  final String arabicName;
  const PaymentMethod(this.arabicName);

  static PaymentMethod fromString(String name) {
    return PaymentMethod.values.firstWhere(
      (e) => e.arabicName == name,
      orElse: () => PaymentMethod.cash,
    );
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\core\security\secure_storage_production.dart ===== 
import 'dart:convert';
import 'dart:math';
import 'dart:typed_data';
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import 'package:encrypt/encrypt.dart' as encrypt;
import 'package:crypto/crypto.dart';
import 'package:get_storage/get_storage.dart';

/// âœ… Ù†Ø¸Ø§Ù… ØªØ´ÙÙŠØ± Ù…Ø¨Ø³Ø· ÙˆØ¢Ù…Ù† Ù„Ù„Ø¥Ù†ØªØ§Ø¬
class SecureStorageProduction {
  static final FlutterSecureStorage _secureStorage = FlutterSecureStorage();
  static final GetStorage _appStorage = GetStorage();
  static encrypt.Encrypter? _encrypter;
  static bool _initialized = false;

  // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´Ø¦
  SecureStorageProduction._();

  /// âœ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
  static Future<void> initialize() async {
    if (_initialized) return;

    try {
      print('ğŸ” Starting encryption system...');

      // 1. ØªÙ‡ÙŠØ¦Ø© GetStorage
      await GetStorage.init();

      // 2. Ø¥Ù†Ø´Ø§Ø¡/Ø¬Ù„Ø¨ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ´ÙÙŠØ±
      final encryptionKey = await _getOrCreateEncryptionKey();

      // 3. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù€ Encrypter
      _encrypter = encrypt.Encrypter(encrypt.AES(
        encrypt.Key.fromBase64(encryptionKey),
      ));

      // 4. Ù‡Ø¬Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      await _migrateOldData();

      _initialized = true;
      print('âœ… Encryption system ready (AES-256)');
    } catch (e) {
      print('âš ï¸ Encryption init warning: $e');
      // Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ± ÙƒØ­Ù„ Ø¨Ø¯ÙŠÙ„
      _initialized = true;
    }
  }

  /// âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ´ÙÙŠØ± Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
  static Future<String> _getOrCreateEncryptionKey() async {
    try {
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø®Ø²Ù†
      String? storedKey = await _secureStorage.read(key: 'aes_256_key');

      if (storedKey != null && storedKey.length >= 32) {
        return storedKey;
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯
      final newKey = _generateEncryptionKey();
      await _secureStorage.write(key: 'aes_256_key', value: newKey);

      return newKey;
    } catch (e) {
      print('âš ï¸ Using fallback encryption key');
      // Ù…ÙØªØ§Ø­ Ø§Ø­ØªÙŠØ§Ø·ÙŠ (ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ±Ù‡ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)
      return 'ZmFuYW5jZV9hcHBfc2VjdXJlX2tleQ=='; // base64 Ù„Ù€ "finance_app_secure_key"
    }
  }

  /// âœ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ ØªØ´ÙÙŠØ± Ù‚ÙˆÙŠ
  static String _generateEncryptionKey() {
    final random = Random.secure();
    final bytes = List<int>.generate(32, (_) => random.nextInt(256));

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… SHA-256 Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    final timestamp = DateTime.now().microsecondsSinceEpoch.toString();
    final combined = Uint8List.fromList([...bytes, ...utf8.encode(timestamp)]);
    final hash = sha256.convert(combined);

    return base64Encode(hash.bytes.sublist(0, 32));
  }

  /// âœ… ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  static String _encryptData(String plaintext) {
    if (_encrypter == null) {
      throw Exception('Encryption system not ready');
    }

    try {
      // IV Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ´ÙÙŠØ±
      final iv = encrypt.IV.fromSecureRandom(16);

      // ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      final encrypted = _encrypter!.encrypt(plaintext, iv: iv);

      // ØªØ®Ø²ÙŠÙ† IV Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (base64)
      return jsonEncode({
        'iv': iv.base64,
        'data': encrypted.base64,
        'v': '1.0', // Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ´ÙÙŠØ±
      });
    } catch (e) {
      print('âŒ Encryption failed: $e');
      throw Exception('ÙØ´Ù„ ÙÙŠ ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  }

  /// âœ… ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  static String _decryptData(String encryptedJson) {
    if (_encrypter == null) {
      throw Exception('Encryption system not ready');
    }

    try {
      final data = jsonDecode(encryptedJson) as Map<String, dynamic>;

      final iv = encrypt.IV.fromBase64(data['iv'] as String);
      final encrypted = encrypt.Encrypted.fromBase64(data['data'] as String);

      return _encrypter!.decrypt(encrypted, iv: iv);
    } catch (e) {
      print('âŒ Decryption failed: $e');
      throw Exception('ÙØ´Ù„ ÙÙŠ ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  }

  /// âœ… ÙƒØªØ§Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ÙØ±Ø©
  static Future<void> writeEncrypted(String key, dynamic data) async {
    if (!_initialized) {
      await initialize();
    }

    try {
      String jsonData;

      if (data is Map || data is List) {
        jsonData = jsonEncode(data);
      } else if (data is String) {
        jsonData = data;
      } else {
        jsonData = jsonEncode(data);
      }

      // ØªØ´ÙÙŠØ± Ø«Ù… ØªØ®Ø²ÙŠÙ†
      final encrypted = _encryptData(jsonData);
      await _appStorage.write(key, encrypted);
    } catch (e) {
      print('âš ï¸ Writing unencrypted data for key: $key');
      // ØªØ®Ø²ÙŠÙ† ØºÙŠØ± Ù…Ø´ÙØ± ÙƒØ­Ù„ Ø¨Ø¯ÙŠÙ„
      await _appStorage.write(key, data);
    }
  }

  /// âœ… Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ÙØ±Ø©
  static dynamic readEncrypted(String key) {
    if (!_initialized) {
      throw Exception('Storage not initialized');
    }

    try {
      final data = _appStorage.read(key);

      if (data == null) return null;

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ÙØ±Ø© (ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ JSON Ù…Ø¹ iv Ùˆ data)
      if (data is String && data.contains('"iv"') && data.contains('"data"')) {
        final decrypted = _decryptData(data);
        return jsonDecode(decrypted);
      }

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± Ù…Ø´ÙØ±Ø©
      return data;
    } catch (e) {
      print('âš ï¸ Error reading key $key: $e');
      return _appStorage.read(key); // Ø¥Ø±Ø¬Ø§Ø¹ ØºÙŠØ± Ù…Ø´ÙØ±
    }
  }

  /// âœ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª
  static Future<void> remove(String key) async {
    try {
      await _appStorage.remove(key);
    } catch (e) {
      print('âš ï¸ Error removing key $key: $e');
    }
  }

  /// âœ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  static Future<void> erase() async {
    try {
      await _appStorage.erase();
      await _secureStorage.delete(key: 'aes_256_key');
      print('âœ… All data cleared');
    } catch (e) {
      print('âš ï¸ Error clearing data: $e');
    }
  }

  /// âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
  static bool hasData(String key) {
    return _appStorage.hasData(key);
  }

  /// âœ… Ù‡Ø¬Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  static Future<void> _migrateOldData() async {
    try {
      final migrationKeys = ['expenses', 'monthlyBudget', 'categoryBudgets'];

      for (final key in migrationKeys) {
        final oldData = _appStorage.read(key);

        if (oldData != null) {
          print('ğŸ”„ Migrating $key...');
          await writeEncrypted(key, oldData);
          print('âœ… $key migrated');
        }
      }
    } catch (e) {
      print('âš ï¸ Migration error: $e');
    }
  }

  /// âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
  static Future<Map<String, dynamic>> getStatus() async {
    final hasKey = await _secureStorage.containsKey(key: 'aes_256_key');

    return {
      'initialized': _initialized,
      'encryptionActive': _encrypter != null,
      'hasEncryptionKey': hasKey,
      'algorithm': _encrypter != null ? 'AES-256-CBC' : 'None',
      'storageProvider': 'GetStorage + FlutterSecureStorage',
      'keysCount': _appStorage.getKeys().length,
    };
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\core\security\security_check.dart ===== 
import 'package:flutter/material.dart';
import 'secure_storage_production.dart';

/// âœ… ÙØ­Øµ Ø£Ù…Ù†ÙŠ Ø³Ø±ÙŠØ¹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
class SecurityCheck {
  static Future<bool> performSecurityCheck() async {
    try {
      print('ğŸ” Performing security check...');

      // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ù†ÙŠ
      await SecureStorageProduction.initialize();

      // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ÙÙŠØ±
      final status = await SecureStorageProduction.getStatus();

      print('ğŸ“Š Security Status:');
      print('   - Initialized: ${status['initialized']}');
      print('   - Encryption: ${status['encryptionActive']}');
      print('   - Has Key: ${status['hasEncryptionKey']}');
      print('   - Algorithm: ${status['algorithm']}');
      print('   - Keys Count: ${status['keysCount']}');

      // 3. Ø§Ø®ØªØ¨Ø§Ø± ØªØ´ÙÙŠØ± ÙˆÙÙƒ ØªØ´ÙÙŠØ± Ø¨Ø³ÙŠØ·
      final testData = {
        'test': 'security_check',
        'timestamp': DateTime.now().toString()
      };
      await SecureStorageProduction.writeEncrypted('_security_test', testData);
      final retrieved = SecureStorageProduction.readEncrypted('_security_test');

      if (retrieved != null && retrieved['test'] == 'security_check') {
        print('âœ… Security check passed');
        return true;
      } else {
        print('âš ï¸ Security check warning (fallback mode)');
        return true; // Ù†Ø³ØªÙ…Ø± Ù…Ø¹ ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
      }
    } catch (e, stackTrace) {
      print('âŒ Security check failed: $e');
      print('Stack trace: $stackTrace');

      // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ØŒ Ù†Ø³ØªÙ…Ø± Ù…Ø¹ ÙˆØ¶Ø¹ ØºÙŠØ± Ø¢Ù…Ù†
      return false;
    }
  }

  /// âœ… Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
  static void showSecurityAlert(BuildContext context, {bool isSecure = true}) {
    if (!isSecure) {
      WidgetsBinding.instance.addPostFrameCallback((_) {
        showDialog(
          context: context,
          barrierDismissible: false,
          builder: (context) => AlertDialog(
            title: const Row(
              children: [
                Icon(Icons.warning, color: Colors.orange),
                SizedBox(width: 10),
                Text('ØªØ­Ø°ÙŠØ± Ø£Ù…Ù†ÙŠ'),
              ],
            ),
            content: const Text(
              'Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ÙÙŠØ± ØºÙŠØ± Ù†Ø´Ø·. '
              'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªÙƒÙˆÙ† Ù…Ø®Ø²Ù†Ø© Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±. '
              'Ù‡Ø°Ø§ Ù…Ù‚Ø¨ÙˆÙ„ Ù„Ù„ØªØ·ÙˆÙŠØ± Ù„ÙƒÙ† Ù„ÙŠØ³ Ù„Ù„Ø¥Ù†ØªØ§Ø¬.',
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text('Ù…ØªØ§Ø¨Ø¹Ø©'),
              ),
            ],
          ),
        );
      });
    }
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\core\security\simple_encryption.dart ===== 
import 'dart:convert';
import 'dart:math';
import 'dart:typed_data';
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import 'package:encrypt/encrypt.dart' as encrypt;
import 'package:get_storage/get_storage.dart';

/// âœ… Ù†Ø¸Ø§Ù… ØªØ´ÙÙŠØ± Ù…Ø¨Ø³Ø· ÙˆØ¢Ù…Ù†
class SimpleEncryption {
  static final FlutterSecureStorage _secureStorage = FlutterSecureStorage();
  static final GetStorage _appStorage = GetStorage();
  static encrypt.Encrypter? _encrypter;
  static bool _initialized = false;
  static bool _initializing = false;

  /// âœ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
  static Future<void> initialize() async {
    if (_initialized || _initializing) return;
    _initializing = true;

    try {
      print('ğŸ” ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ÙÙŠØ±...');

      // Important: initialize GetStorage
      await GetStorage.init();

      final key = await _getEncryptionKey();
      _encrypter = encrypt.Encrypter(encrypt.AES(key));
      _initialized = true;
      _initializing = false;

      print('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ÙÙŠØ± Ø¬Ø§Ù‡Ø² (AES-256)');
    } catch (e) {
      _initializing = false;
      print('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ´ÙÙŠØ±: $e');
      _initialized = true; // Ù†Ø³ØªÙ…Ø± Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±
    }
  }

  /// âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ´ÙÙŠØ±
  static Future<encrypt.Key> _getEncryptionKey() async {
    try {
      final storedKey = await _secureStorage.read(key: 'finance_app_key');

      if (storedKey != null && storedKey.isNotEmpty) {
        return encrypt.Key.fromBase64(storedKey);
      }

      final newKey = _generateKey();
      await _secureStorage.write(
        key: 'finance_app_key',
        value: newKey.base64,
      );

      return newKey;
    } catch (e) {
      print('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ Ø§Ø­ØªÙŠØ§Ø·ÙŠ');
      return _generateKey();
    }
  }

  /// âœ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­
  static encrypt.Key _generateKey() {
    final random = Random.secure();
    final bytes = Uint8List(32);

    for (int i = 0; i < bytes.length; i++) {
      bytes[i] = random.nextInt(256);
    }

    return encrypt.Key(bytes);
  }

  /// âœ… ÙƒØªØ§Ø¨Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ÙØ±Ø©
  static Future<void> write(String key, dynamic data) async {
    if (!_initialized) {
      await initialize();
    }

    try {
      final jsonString = jsonEncode(data);
      final encrypted = _encrypt(jsonString);
      await _appStorage.write(key, encrypted);
    } catch (e) {
      // ØªØ®Ø²ÙŠÙ† Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±
      await _appStorage.write(key, data);
    }
  }

  /// âœ… Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ÙØ±Ø©
  static dynamic read(String key) {
    try {
      final data = _appStorage.read(key);
      if (data == null) return null;

      if (data is String && data.startsWith('{"iv":')) {
        final decrypted = _decrypt(data);
        return jsonDecode(decrypted);
      }

      return data;
    } catch (e) {
      return _appStorage.read(key);
    }
  }

  /// âœ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª
  static Future<void> remove(String key) async {
    try {
      await _appStorage.remove(key);
      print('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙØªØ§Ø­: $key');
    } catch (e) {
      print('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙØªØ§Ø­ $key: $e');
      rethrow;
    }
  }

  /// âœ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  static Future<void> clearAll() async {
    try {
      await _appStorage.erase();
      await _secureStorage.delete(key: 'finance_app_key');
      _encrypter = null;
      _initialized = false;
      print('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    } catch (e) {
      print('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: $e');
    }
  }

  /// âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
  static bool has(String key) {
    return _appStorage.hasData(key);
  }

  /// âœ… ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  static String _encrypt(String plaintext) {
    if (_encrypter == null) return plaintext;

    try {
      final iv = encrypt.IV.fromSecureRandom(16);
      final encrypted = _encrypter!.encrypt(plaintext, iv: iv);

      return jsonEncode({
        'iv': iv.base64,
        'data': encrypted.base64,
        'v': '1.0',
      });
    } catch (e) {
      print('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ´ÙÙŠØ±: $e');
      return plaintext;
    }
  }

  /// âœ… ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±
  static String _decrypt(String encryptedJson) {
    if (_encrypter == null) return encryptedJson;

    try {
      final map = jsonDecode(encryptedJson) as Map<String, dynamic>;
      final iv = encrypt.IV.fromBase64(map['iv']);
      final encrypted = encrypt.Encrypted.fromBase64(map['data']);
      return _encrypter!.decrypt(encrypted, iv: iv);
    } catch (e) {
      print('âš ï¸ ÙØ´Ù„ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±: $e');
      return encryptedJson;
    }
  }

  /// âœ… Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
  static String get status =>
      _encrypter != null ? 'Encryption Active' : 'Encryption Inactive';
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\core\utils\error_handler.dart ===== 
import 'dart:async'; //  for  TimeoutException
import 'package:flutter/material.dart';
import 'package:get/get.dart';

// Remove the Logger import for now  :
// import 'package:logger/logger.dart';

class ErrorHandler {
  static bool _isShowingDialog = false;

  // Simple logging methods until we add the logger package
  static void _log(String level, String message,
      {dynamic error, dynamic stackTrace}) {
    final timestamp = DateTime.now().toIso8601String();
    print('[$timestamp] [$level] $message');
    if (error != null) {
      print('Error: $error');
    }
    if (stackTrace != null) {
      print('Stack trace: $stackTrace');
    }
  }

  static void showError(String message, {String title = 'Ø®Ø·Ø£'}) {
    try {
      // Close any existing snackbars
      if (Get.isSnackbarOpen == true) {
        Get.back();
      }

      _log('ERROR', '$title - $message');

      Get.snackbar(
        title,
        message,
        snackPosition: SnackPosition.BOTTOM,
        duration: const Duration(seconds: 4),
        backgroundColor: Colors.red[100],
        colorText: Colors.red[900],
        icon: const Icon(Icons.error, color: Colors.red),
        shouldIconPulse: true,
        margin: const EdgeInsets.all(10),
        borderRadius: 8,
        animationDuration: const Duration(milliseconds: 300),
        mainButton: TextButton(
          onPressed: () => Get.back(),
          child: const Text('Ø¥ØºÙ„Ø§Ù‚', style: TextStyle(color: Colors.red)),
        ),
        onTap: (_) => Get.back(),
      );
    } catch (e) {
      _log('ERROR', 'Failed to show error snackbar: $e');
      // Fallback to console
      print('ERROR: $title - $message');
    }
  }

  static void showSuccess(String message, {String title = 'Ù†Ø¬Ø§Ø­'}) {
    try {
      if (Get.isSnackbarOpen == true) {
        Get.back();
      }

      _log('INFO', '$title - $message');

      Get.snackbar(
        title,
        message,
        snackPosition: SnackPosition.BOTTOM,
        duration: const Duration(seconds: 3),
        backgroundColor: Colors.green[100],
        colorText: Colors.green[900],
        icon: const Icon(Icons.check_circle, color: Colors.green),
        margin: const EdgeInsets.all(10),
        borderRadius: 8,
        animationDuration: const Duration(milliseconds: 300),
        onTap: (_) => Get.back(),
      );
    } catch (e) {
      _log('ERROR', 'Failed to show success snackbar: $e');
      print('SUCCESS: $title - $message');
    }
  }

  static void showWarning(String message, {String title = 'ØªØ­Ø°ÙŠØ±'}) {
    try {
      if (Get.isSnackbarOpen == true) {
        Get.back();
      }

      _log('WARNING', '$title - $message');

      Get.snackbar(
        title,
        message,
        snackPosition: SnackPosition.BOTTOM,
        duration: const Duration(seconds: 4),
        backgroundColor: Colors.orange[100],
        colorText: Colors.orange[900],
        icon: const Icon(Icons.warning, color: Colors.orange),
        margin: const EdgeInsets.all(10),
        borderRadius: 8,
        animationDuration: const Duration(milliseconds: 300),
        onTap: (_) => Get.back(),
      );
    } catch (e) {
      _log('ERROR', 'Failed to show warning snackbar: $e');
      print('WARNING: $title - $message');
    }
  }

  static Future<bool> showConfirmationDialog({
    required String title,
    required String message,
    String confirmText = 'Ù†Ø¹Ù…',
    String cancelText = 'Ù„Ø§',
    Color confirmColor = Colors.red,
    bool barrierDismissible = false,
  }) async {
    if (_isShowingDialog) return false;

    _isShowingDialog = true;
    _log('DEBUG', 'Showing confirmation dialog: $title');

    try {
      final result = await Get.dialog<bool>(
        WillPopScope(
          onWillPop: () async {
            _isShowingDialog = false;
            return barrierDismissible;
          },
          child: AlertDialog(
            title: Text(title,
                style: const TextStyle(fontWeight: FontWeight.bold)),
            content: SingleChildScrollView(
              child: Text(message),
            ),
            actions: [
              TextButton(
                onPressed: () {
                  _isShowingDialog = false;
                  Get.back(result: false);
                },
                child: Text(cancelText,
                    style: const TextStyle(fontSize: 16, color: Colors.grey)),
              ),
              ElevatedButton(
                onPressed: () {
                  _isShowingDialog = false;
                  Get.back(result: true);
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: confirmColor,
                  foregroundColor: Colors.white,
                  padding:
                      const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                ),
                child: Text(confirmText, style: const TextStyle(fontSize: 16)),
              ),
            ],
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
          ),
        ),
        barrierDismissible: barrierDismissible,
      );

      final bool finalResult = result ?? false;
      _log('DEBUG', 'Confirmation dialog result: $finalResult');
      return finalResult;
    } catch (e) {
      _isShowingDialog = false;
      _log('ERROR', 'Failed to show confirmation dialog: $e');
      return false;
    }
  }

  static void handleApiError(dynamic error, {String? context}) {
    String errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹';

    if (error is String) {
      errorMessage = error;
    } else if (error is FormatException) {
      errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    } else if (error is TimeoutException) {
      errorMessage = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„';
    } else if (error is Exception) {
      errorMessage = error.toString();
    }

    _log('ERROR', 'API Error${context != null ? " in $context" : ""}: $error');
    showError(errorMessage);
  }

  static void showLoading({String message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'}) {
    try {
      if (Get.isDialogOpen != true) {
        _log('DEBUG', 'Showing loading dialog: $message');

        Get.dialog(
          WillPopScope(
            onWillPop: () async => false,
            child: Dialog(
              backgroundColor: Colors.transparent,
              elevation: 0,
              child: Center(
                child: Container(
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      const CircularProgressIndicator(),
                      const SizedBox(height: 16),
                      Text(message),
                    ],
                  ),
                ),
              ),
            ),
          ),
          barrierDismissible: false,
        );
      }
    } catch (e) {
      _log('ERROR', 'Failed to show loading dialog: $e');
    }
  }

  static void hideLoading() {
    try {
      if (Get.isDialogOpen == true) {
        _log('DEBUG', 'Hiding loading dialog');
        Get.back();
      }
    } catch (e) {
      _log('ERROR', 'Failed to hide loading dialog: $e');
    }
  }

  static void logInfo(String message, {String? tag}) {
    _log('INFO', '${tag != null ? '[$tag] ' : ''}$message');
  }

  static void logWarning(String message, {String? tag}) {
    _log('WARNING', '${tag != null ? '[$tag] ' : ''}$message');
  }

  static void logError(String message,
      {String? tag, dynamic error, dynamic stackTrace}) {
    _log('ERROR', '${tag != null ? '[$tag] ' : ''}$message',
        error: error, stackTrace: stackTrace);
  }

  static void logDebug(String message, {String? tag}) {
    _log('DEBUG', '${tag != null ? '[$tag] ' : ''}$message');
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\alerts\presentation\controllers\alert_controller.dart ===== 
// lib/features/alerts/presentation/controllers/alert_controller.dart

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:get_storage/get_storage.dart';

class AlertController extends GetxController {
  final _storage = GetStorage();

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
  final budgetAlertsEnabled = true.obs;
  final largeExpenseAlertsEnabled = true.obs;
  final dailySummaryEnabled = false.obs;

  // Ø¹ØªØ¨Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
  final budgetAlertThreshold = 80.0.obs; // Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
  final largeExpenseThreshold = 500.0.obs; // Ù…Ø¨Ù„Øº ÙƒØ¨ÙŠØ±

  @override
  void onInit() {
    super.onInit();
    loadAlertSettings();
  }

  void loadAlertSettings() {
    budgetAlertsEnabled.value = _storage.read('budgetAlerts') ?? true;
    largeExpenseAlertsEnabled.value =
        _storage.read('largeExpenseAlerts') ?? true;
    dailySummaryEnabled.value = _storage.read('dailySummary') ?? false;
    budgetAlertThreshold.value = _storage.read('budgetThreshold') ?? 80.0;
    largeExpenseThreshold.value =
        _storage.read('largeExpenseThreshold') ?? 500.0;
  }

  Future<void> saveAlertSettings() async {
    await _storage.write('budgetAlerts', budgetAlertsEnabled.value);
    await _storage.write('largeExpenseAlerts', largeExpenseAlertsEnabled.value);
    await _storage.write('dailySummary', dailySummaryEnabled.value);
    await _storage.write('budgetThreshold', budgetAlertThreshold.value);
    await _storage.write('largeExpenseThreshold', largeExpenseThreshold.value);
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©
  void checkExpenseAlerts(double amount, String category) {
    if (largeExpenseAlertsEnabled.value &&
        amount >= largeExpenseThreshold.value) {
      showLargeExpenseAlert(amount, category);
    }

    // Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„Ø§Ø­Ù‚Ø§Ù‹
  }

  void showLargeExpenseAlert(double amount, String category) {
    Get.snackbar(
      'Ù…ØµØ±ÙˆÙ ÙƒØ¨ÙŠØ±! ğŸ’¸',
      'Ù„Ù‚Ø¯ Ø£Ù†ÙÙ‚Øª $amount Ø¬.Ù… Ø¹Ù„Ù‰ $category',
      snackPosition: SnackPosition.BOTTOM,
      duration: const Duration(seconds: 3),
      backgroundColor: Colors.orange[100],
      colorText: Colors.orange[900],
    );
  }

  // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
  void checkBudgetAlerts(double spentPercentage, double remainingBudget) {
    if (!budgetAlertsEnabled.value) return;

    if (spentPercentage >= budgetAlertThreshold.value) {
      showBudgetAlert(spentPercentage, remainingBudget);
    }

    if (remainingBudget < 0) {
      showBudgetExceededAlert(remainingBudget.abs());
    }
  }

  void showBudgetAlert(double percentage, double remaining) {
    Get.snackbar(
      'ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© âš ï¸',
      'Ù„Ù‚Ø¯ Ø£Ù†ÙÙ‚Øª ${percentage.toStringAsFixed(1)}% Ù…Ù† Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ\nØ§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining.toStringAsFixed(2)} Ø¬.Ù…',
      snackPosition: SnackPosition.BOTTOM,
      duration: const Duration(seconds: 4),
      backgroundColor: Colors.orange[100],
      colorText: Colors.orange[900],
    );
  }

  void showBudgetExceededAlert(double exceededAmount) {
    Get.snackbar(
      'ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©! ğŸš¨',
      'Ù„Ù‚Ø¯ ØªØ¬Ø§ÙˆØ²Øª Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø¨Ù…Ù‚Ø¯Ø§Ø± ${exceededAmount.toStringAsFixed(2)} Ø¬.Ù…',
      snackPosition: SnackPosition.BOTTOM,
      duration: const Duration(seconds: 5),
      backgroundColor: Colors.red[100],
      colorText: Colors.red[900],
    );
  }

  // Ù…Ù„Ø®Øµ ÙŠÙˆÙ…ÙŠ
  void showDailySummary(double dailyIncome, double dailyExpense) {
    if (!dailySummaryEnabled.value) return;

    Get.defaultDialog(
      title: 'Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ… ğŸ“Š',
      middleText: 'Ø§Ù„Ø¯Ø®Ù„: ${dailyIncome.toStringAsFixed(2)} Ø¬.Ù…\n'
          'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${dailyExpense.toStringAsFixed(2)} Ø¬.Ù…\n'
          'Ø§Ù„ØµØ§ÙÙŠ: ${(dailyIncome - dailyExpense).toStringAsFixed(2)} Ø¬.Ù…',
      textConfirm: 'Ø­Ø³Ù†Ø§Ù‹',
      onConfirm: Get.back,
    );
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\alerts\presentation\pages\alerts_settings_page.dart ===== 
// lib/features/alerts/presentation/pages/alerts_settings_page.dart

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import '../controllers/alert_controller.dart';

class AlertsSettingsPage extends StatelessWidget {
  AlertsSettingsPage({super.key});
  final AlertController _controller = Get.find();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª'),
        centerTitle: true,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
            Card(
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        const Icon(Icons.account_balance_wallet,
                            color: Colors.orange),
                        const SizedBox(width: 12),
                        const Expanded(
                          child: Text(
                            'ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                        Obx(() => Switch(
                              value: _controller.budgetAlertsEnabled.value,
                              onChanged: (value) {
                                _controller.budgetAlertsEnabled.value = value;
                                _controller.saveAlertSettings();
                              },
                            )),
                      ],
                    ),
                    const SizedBox(height: 12),
                    Obx(() => Column(
                          children: [
                            Text(
                              'Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ ${_controller.budgetAlertThreshold.value.toInt()}% Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
                              style: const TextStyle(color: Colors.grey),
                            ),
                            Slider(
                              value: _controller.budgetAlertThreshold.value,
                              min: 50,
                              max: 100,
                              divisions: 10,
                              label:
                                  '${_controller.budgetAlertThreshold.value.toInt()}%',
                              onChanged: _controller.budgetAlertsEnabled.value
                                  ? (value) {
                                      _controller.budgetAlertThreshold.value =
                                          value;
                                      _controller.saveAlertSettings();
                                    }
                                  : null,
                            ),
                          ],
                        )),
                  ],
                ),
              ),
            ),

            const SizedBox(height: 16),

            // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
            Card(
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        const Icon(Icons.warning, color: Colors.red),
                        const SizedBox(width: 12),
                        const Expanded(
                          child: Text(
                            'ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©',
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                        Obx(() => Switch(
                              value:
                                  _controller.largeExpenseAlertsEnabled.value,
                              onChanged: (value) {
                                _controller.largeExpenseAlertsEnabled.value =
                                    value;
                                _controller.saveAlertSettings();
                              },
                            )),
                      ],
                    ),
                    const SizedBox(height: 12),
                    Obx(() => Column(
                          children: [
                            Text(
                              'Ø¹Ù†Ø¯ Ø¥Ù†ÙØ§Ù‚ Ø£ÙƒØ«Ø± Ù…Ù† ${_controller.largeExpenseThreshold.value} Ø¬.Ù…',
                              style: const TextStyle(color: Colors.grey),
                            ),
                            Slider(
                              value: _controller.largeExpenseThreshold.value,
                              min: 100,
                              max: 2000,
                              divisions: 19,
                              label:
                                  '${_controller.largeExpenseThreshold.value.toInt()} Ø¬.Ù…',
                              onChanged: _controller
                                      .largeExpenseAlertsEnabled.value
                                  ? (value) {
                                      _controller.largeExpenseThreshold.value =
                                          value;
                                      _controller.saveAlertSettings();
                                    }
                                  : null,
                            ),
                          ],
                        )),
                  ],
                ),
              ),
            ),

            const SizedBox(height: 16),

            // Ù…Ù„Ø®Øµ ÙŠÙˆÙ…ÙŠ
            Card(
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Row(
                  children: [
                    const Icon(Icons.summarize, color: Colors.blue),
                    const SizedBox(width: 12),
                    const Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'Ù…Ù„Ø®Øµ ÙŠÙˆÙ…ÙŠ',
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          Text(
                            'Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                            style: TextStyle(fontSize: 12, color: Colors.grey),
                          ),
                        ],
                      ),
                    ),
                    Obx(() => Switch(
                          value: _controller.dailySummaryEnabled.value,
                          onChanged: (value) {
                            _controller.dailySummaryEnabled.value = value;
                            _controller.saveAlertSettings();
                          },
                        )),
                  ],
                ),
              ),
            ),

            const SizedBox(height: 32),

            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
            Center(
              child: ElevatedButton.icon(
                onPressed: () {
                  _controller.showLargeExpenseAlert(600, 'ØªØ³ÙˆÙ‚');
                },
                icon: const Icon(Icons.notifications_active),
                label: const Text('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª'),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.orange,
                  foregroundColor: Colors.white,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\backup\presentation\controllers\backup_controller.dart ===== 
// lib/features/backup/presentation/controllers/backup_controller.dart

import 'dart:convert';
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:get_storage/get_storage.dart';
import 'package:intl/intl.dart';
import 'package:path_provider/path_provider.dart';
import 'package:share_plus/share_plus.dart';
import 'package:file_picker/file_picker.dart';

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ØªØ­ÙƒÙ…Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
import 'package:finance_app/features/expense/presentation/controllers/expense_controller.dart';
import 'package:finance_app/features/expense/presentation/controllers/budget_controller.dart';
import 'package:finance_app/features/alerts/presentation/controllers/alert_controller.dart';
import 'package:finance_app/features/search/presentation/controllers/expense_search_controller.dart';

class BackupController extends GetxController {
  final GetStorage _storage = GetStorage();
  final RxBool isLoading = false.obs;
  final Rx<DateTime?> lastBackupDate = Rx<DateTime?>(null);

  @override
  void onInit() {
    super.onInit();
    loadLastBackupDate();
  }

  // ØªØ­Ù…ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
  void loadLastBackupDate() {
    final dateStr = _storage.read('lastBackupDate');
    if (dateStr != null) {
      lastBackupDate.value = DateTime.parse(dateStr);
    }
  }

  // 1. Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø©
  Future<void> createBackup() async {
    isLoading.value = true;

    try {
      // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      final Map<String, dynamic> backupData = {
        'appName': 'Finance App',
        'version': '1.0.0',
        'backupDate': DateTime.now().toIso8601String(),
        'data': {
          'expenses': _storage.read('expenses') ?? [],
          'monthlyBudget': _storage.read('monthlyBudget'),
          'categoryBudgets': _storage.read('categoryBudgets'),
          'budgetAlerts': _storage.read('budgetAlerts'),
          'largeExpenseAlerts': _storage.read('largeExpenseAlerts'),
          'dailySummary': _storage.read('dailySummary'),
          'budgetThreshold': _storage.read('budgetThreshold'),
          'largeExpenseThreshold': _storage.read('largeExpenseThreshold'),
        },
      };

      // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ JSON
      final jsonData = jsonEncode(backupData);

      // Ø­ÙØ¸ ÙÙŠ Ù…Ù„Ù
      final directory = await getApplicationDocumentsDirectory();
      final timestamp = DateFormat('yyyyMMdd_HHmmss').format(DateTime.now());
      final file = File('${directory.path}/finance_backup_$timestamp.json');
      await file.writeAsString(jsonData);

      // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      lastBackupDate.value = DateTime.now();
      await _storage.write('lastBackupDate', DateTime.now().toIso8601String());

      Get.snackbar(
        'âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
        'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
        snackPosition: SnackPosition.BOTTOM,
        backgroundColor: Colors.green[100],
        colorText: Colors.green[900],
      );

      // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù
      await _shareBackupFile(file);
    } catch (e, stackTrace) {
      print('âŒ Backup error: $e');
      print('Stack trace: $stackTrace');

      Get.snackbar(
        'âŒ Ø®Ø·Ø£',
        'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${e.toString()}',
        snackPosition: SnackPosition.BOTTOM,
        backgroundColor: Colors.red[100],
        colorText: Colors.red[900],
      );
    } finally {
      isLoading.value = false;
    }
  }

  // 2. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
  Future<void> restoreBackup() async {
    try {
      // Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      FilePickerResult? result = await FilePicker.platform.pickFiles(
        type: FileType.custom,
        allowedExtensions: ['json'],
        allowMultiple: false,
      );

      if (result == null || result.files.isEmpty) {
        return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù„ØºÙ‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      }

      PlatformFile file = result.files.first;
      final filePath = file.path;

      if (filePath == null) {
        throw Exception('Ù…Ø³Ø§Ø± Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
      }

      isLoading.value = true;

      // Ù‚Ø±Ø§Ø¡Ø© ÙˆØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      final backupFile = File(filePath);
      final jsonData = await backupFile.readAsString();
      final backupData = jsonDecode(jsonData);

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      if (backupData['appName'] != 'Finance App') {
        throw Exception(
            'Ù…Ù„Ù Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­: Ù„ÙŠØ³ Ù…Ù„Ù ØªØ·Ø¨ÙŠÙ‚ Finance App');
      }

      // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯
      final bool proceed = await Get.dialog<bool>(
            AlertDialog(
              title: const Row(
                children: [
                  Icon(Icons.warning, color: Colors.orange),
                  SizedBox(width: 8),
                  Text('âš ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©'),
                ],
              ),
              content: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text('Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ${backupData['appName']}'),
                  Text('Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${backupData['version']}'),
                  Text(
                      'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${DateFormat('yyyy/MM/dd HH:mm').format(DateTime.parse(backupData['backupDate']))}'),
                  const SizedBox(height: 16),
                  const Text(
                    'âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©!',
                    style: TextStyle(
                        color: Colors.red, fontWeight: FontWeight.bold),
                  ),
                  const SizedBox(height: 8),
                  const Text(
                    'Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.',
                    style: TextStyle(color: Colors.grey),
                  ),
                ],
              ),
              actions: [
                TextButton(
                  onPressed: () => Get.back(result: false),
                  child: const Text('Ø¥Ù„ØºØ§Ø¡'),
                ),
                ElevatedButton(
                  onPressed: () => Get.back(result: true),
                  style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
                  child: const Text('Ø§Ø³ØªØ¹Ø§Ø¯Ø©'),
                ),
              ],
            ),
          ) ??
          false;

      if (!proceed) {
        isLoading.value = false;
        return;
      }

      // ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
      await _performRestore(backupData['data']);

      Get.snackbar(
        'âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­',
        'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­',
        snackPosition: SnackPosition.BOTTOM,
        backgroundColor: Colors.green[100],
        colorText: Colors.green[900],
      );
    } catch (e, stackTrace) {
      print('âŒ Restore error: $e');
      print('Stack trace: $stackTrace');

      Get.snackbar(
        'âŒ ÙØ´Ù„Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
        'Ø®Ø·Ø£: ${e.toString()}',
        snackPosition: SnackPosition.BOTTOM,
        backgroundColor: Colors.red[100],
        colorText: Colors.red[900],
      );
    } finally {
      isLoading.value = false;
    }
  }

  // 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ©
  Future<void> _performRestore(Map<String, dynamic> backupData) async {
    try {
      // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
      await _storage.erase();

      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      await _storage.write('expenses', backupData['expenses'] ?? []);
      await _storage.write('monthlyBudget', backupData['monthlyBudget']);
      await _storage.write('categoryBudgets', backupData['categoryBudgets']);
      await _storage.write('budgetAlerts', backupData['budgetAlerts']);
      await _storage.write(
          'largeExpenseAlerts', backupData['largeExpenseAlerts']);
      await _storage.write('dailySummary', backupData['dailySummary']);
      await _storage.write('budgetThreshold', backupData['budgetThreshold']);
      await _storage.write(
          'largeExpenseThreshold', backupData['largeExpenseThreshold']);

      // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      lastBackupDate.value = DateTime.now();
      await _storage.write('lastBackupDate', DateTime.now().toIso8601String());

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…ØªØ­ÙƒÙ…Ø§Øª
      await _reloadAllControllers();
    } catch (e) {
      rethrow;
    }
  }

  // 4. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…ØªØ­ÙƒÙ…Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
  Future<void> _reloadAllControllers() async {
    try {
      // Expense Controller
      if (Get.isRegistered<ExpenseController>()) {
        final expenseController = Get.find<ExpenseController>();
        expenseController.loadExpenses();
      }

      // Budget Controller
      if (Get.isRegistered<BudgetController>()) {
        final budgetController = Get.find<BudgetController>();
        budgetController.loadBudgetData();
      }

      // Alert Controller
      if (Get.isRegistered<AlertController>()) {
        final alertController = Get.find<AlertController>();
        alertController.loadAlertSettings();
      }

      // Search Controller
      if (Get.isRegistered<ExpenseSearchController>()) {
        final searchController = Get.find<ExpenseSearchController>();
        searchController.resetFilters();
      }
    } catch (e) {
      print('Error reloading controllers: $e');
    }
  }

  // 5. Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
  Future<void> _shareBackupFile(File file) async {
    try {
      await Share.shareXFiles(
        [XFile(file.path)],
        text:
            'Finance App Backup - ${DateFormat('yyyy/MM/dd HH:mm').format(DateTime.now())}',
      );
    } catch (e) {
      print('Share error: $e');
    }
  }

  // 6. ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ù†ØµÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø©
  Future<void> exportSimpleBackup() async {
    isLoading.value = true;

    try {
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… ExpenseController Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
      final expenseController = Get.find<ExpenseController>();
      final expenses = expenseController.expensesAsMap;

      if (expenses.isEmpty) {
        Get.snackbar(
          'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
          'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§',
          snackPosition: SnackPosition.BOTTOM,
          backgroundColor: Colors.orange[100],
          colorText: Colors.orange[900],
        );
        isLoading.value = false;
        return;
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
      double totalIncome = 0;
      double totalExpense = 0;
      final Map<String, double> categoryTotals = {};

      for (var expense in expenses) {
        final amount = (expense['amount'] as num).toDouble();
        final isIncome = expense['isIncome'] == true;
        final category = expense['category']?.toString() ?? 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

        if (isIncome) {
          totalIncome += amount;
        } else {
          totalExpense += amount;

          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù„ÙƒÙ„ ÙØ¦Ø©
          categoryTotals.update(
            category,
            (value) => value + amount,
            ifAbsent: () => amount,
          );
        }
      }

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø³Ù‚
      final report = '''
ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ
ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${_formatDateTime(DateTime.now())}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: ${expenses.length}
â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„: ${totalIncome.toStringAsFixed(2)} Ø¬.Ù…
â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${totalExpense.toStringAsFixed(2)} Ø¬.Ù…
â€¢ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ: ${(totalIncome - totalExpense).toStringAsFixed(2)} Ø¬.Ù…

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${_buildCategoryReport(categoryTotals, totalExpense)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ Ø¢Ø®Ø± 5 Ù…Ø¹Ø§Ù…Ù„Ø§Øª:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${_buildRecentTransactions(expenses, limit: 5)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¾ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â€¢ Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ${lastBackupDate.value != null ? _formatDateTime(lastBackupDate.value!) : 'Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©'}
â€¢ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${expenses.length} Ù…Ø¹Ø§Ù…Ù„Ø©
â€¢ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${_formatDateTime(DateTime.now())}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
''';

      // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      await Share.share(
        report,
        subject: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ - ${_formatDate(DateTime.now())}',
      );

      Get.snackbar(
        'âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­',
        'ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØµÙŠ',
        snackPosition: SnackPosition.BOTTOM,
        duration: const Duration(seconds: 2),
        backgroundColor: Colors.green[100],
        colorText: Colors.green[900],
      );
    } catch (e, stackTrace) {
      print('âŒ Error in exportSimpleBackup: $e');
      print('Stack trace: $stackTrace');

      Get.snackbar(
        'âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±',
        'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
        snackPosition: SnackPosition.BOTTOM,
        duration: const Duration(seconds: 4),
        backgroundColor: Colors.red[100],
        colorText: Colors.red[900],
      );
    } finally {
      isLoading.value = false;
    }
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¨Ù†Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ¦Ø§Øª
  String _buildCategoryReport(
      Map<String, double> categories, double totalExpense) {
    if (categories.isEmpty) {
      return 'â€¢ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…ØµÙ†ÙØ©\n';
    }

    final sortedCategories = categories.entries.toList()
      ..sort((a, b) => b.value.compareTo(a.value));

    String report = '';
    for (var entry in sortedCategories) {
      final percentage =
          totalExpense > 0 ? (entry.value / totalExpense * 100) : 0;

      report +=
          'â€¢ ${entry.key}: ${entry.value.toStringAsFixed(2)} Ø¬.Ù… (${percentage.toStringAsFixed(1)}%)\n';
    }

    return report;
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
  String _buildRecentTransactions(List<Map<String, dynamic>> expenses,
      {int limit = 5}) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ§Ø±ØºØ©
    if (expenses.isEmpty) {
      return 'â€¢ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø¯ÙŠØ«Ø©\n';
    }

    // Ù†Ø³Ø® Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    final recent = List<Map<String, dynamic>>.from(expenses);

    recent.sort((a, b) {
      try {
        final dateStrA = a['date']?.toString();
        final dateStrB = b['date']?.toString();

        if (dateStrA == null || dateStrB == null) return 0;

        final dateA = DateTime.parse(dateStrA);
        final dateB = DateTime.parse(dateStrB);

        return dateB.compareTo(dateA); // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
      } catch (e) {
        return 0; // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù„Ø§ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨
      }
    });

    // Ø£Ø®Ø° Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø·
    final limitedList = recent.take(limit).toList();

    if (limitedList.isEmpty) {
      return 'â€¢ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø¯ÙŠØ«Ø©\n';
    }

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    final buffer = StringBuffer();

    for (var expense in limitedList) {
      try {
        final dateStr = expense['date']?.toString();
        if (dateStr == null) continue;

        final date = DateTime.parse(dateStr);
        final formattedDate = _formatDate(date);
        final isIncome = expense['isIncome'] == true;
        final amount = (expense['amount'] as num).toDouble();
        final category = expense['category']?.toString() ?? 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        final description = expense['description']?.toString() ?? '';

        buffer.write('â€¢ $formattedDate: ');
        buffer.write(isIncome ? 'â¬‡ï¸' : 'â¬†ï¸');
        buffer.write(' ${amount.toStringAsFixed(2)} Ø¬.Ù… ($category)');

        if (description.isNotEmpty) {
          buffer.write(' - $description');
        }

        buffer.writeln();
      } catch (e) {
        // ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø©
        print('âš ï¸ ØªØ®Ø·ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©: $e');
        continue;
      }
    }

    return buffer.toString();
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
  String _formatDate(DateTime date) {
    try {
      return DateFormat('yyyy/MM/dd').format(date);
    } catch (e) {
      return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    }
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
  String _formatDateTime(DateTime date) {
    try {
      return DateFormat('yyyy/MM/dd HH:mm').format(date);
    } catch (e) {
      return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    }
  }

  // 7. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
  String get backupInfo {
    if (lastBackupDate.value == null) {
      return 'Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©';
    }

    final diff = DateTime.now().difference(lastBackupDate.value!);

    if (diff.inDays > 0) {
      return 'Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: Ù…Ù†Ø° ${diff.inDays} ÙŠÙˆÙ…';
    } else if (diff.inHours > 0) {
      return 'Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: Ù…Ù†Ø° ${diff.inHours} Ø³Ø§Ø¹Ø©';
    } else if (diff.inMinutes > 0) {
      return 'Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: Ù…Ù†Ø° ${diff.inMinutes} Ø¯Ù‚ÙŠÙ‚Ø©';
    } else {
      return 'Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: Ø§Ù„Ø¢Ù†';
    }
  }

  // 8. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
  Future<int> getBackupFileCount() async {
    try {
      final directory = await getApplicationDocumentsDirectory();
      final files = Directory(directory.path)
          .listSync()
          .where((entity) => entity.path.endsWith('.json'))
          .where((entity) => entity is File)
          .length;
      return files;
    } catch (e) {
      return 0;
    }
  }

  // 9. Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
  Future<void> clearBackupData() async {
    try {
      final confirmed = await Get.dialog<bool>(
        AlertDialog(
          title: const Text('Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ'),
          content:
              const Text('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ'),
          actions: [
            TextButton(
              onPressed: () => Get.back(result: false),
              child: const Text('Ø¥Ù„ØºØ§Ø¡'),
            ),
            ElevatedButton(
              onPressed: () => Get.back(result: true),
              style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
              child: const Text('Ù…Ø³Ø­'),
            ),
          ],
        ),
      );

      if (confirmed == true) {
        await _storage.remove('lastBackupDate');
        lastBackupDate.value = null;
        Get.snackbar(
          'ØªÙ… Ø§Ù„Ù…Ø³Ø­',
          'ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ',
        );
      }
    } catch (e) {
      Get.snackbar('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\backup\presentation\pages\backup_page.dart ===== 
// lib/features/backup/presentation/pages/backup_page.dart

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:intl/intl.dart';
import '../controllers/backup_controller.dart';

class BackupPage extends StatelessWidget {
  BackupPage({super.key});
  final BackupController _controller = Get.find();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©'),
        centerTitle: true,
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(20),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
              Card(
                elevation: 4,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Padding(
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    children: [
                      const Icon(Icons.backup, size: 64, color: Colors.blue),
                      const SizedBox(height: 16),
                      Obx(() => Text(
                            _controller.backupInfo,
                            style: const TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                              color: Colors.blue,
                            ),
                            textAlign: TextAlign.center,
                          )),
                      const SizedBox(height: 8),
                      Obx(() {
                        if (_controller.lastBackupDate.value != null) {
                          return Text(
                            DateFormat('yyyy/MM/dd HH:mm')
                                .format(_controller.lastBackupDate.value!),
                            style: const TextStyle(color: Colors.grey),
                          );
                        }
                        return const SizedBox();
                      }),
                    ],
                  ),
                ),
              ),

              const SizedBox(height: 24),

              // Ø¹Ù†ÙˆØ§Ù† Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
              const Text(
                'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                ),
              ),
              const SizedBox(height: 12),

              // 1. Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø©
              Card(
                elevation: 2,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                child: ListTile(
                  leading: const Icon(Icons.save, color: Colors.green),
                  title: const Text('Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø©'),
                  subtitle: const Text('Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ù„Ù'),
                  trailing: Obx(() => _controller.isLoading.value
                      ? const SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(strokeWidth: 2),
                        )
                      : const Icon(Icons.chevron_right)),
                  onTap: _controller.createBackup,
                ),
              ),

              const SizedBox(height: 8),

              // 2. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
              Card(
                elevation: 2,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                child: ListTile(
                  leading: const Icon(Icons.restore, color: Colors.orange),
                  title: const Text('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©'),
                  subtitle: const Text('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ'),
                  trailing: Obx(() => _controller.isLoading.value
                      ? const SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(strokeWidth: 2),
                        )
                      : const Icon(Icons.chevron_right)),
                  onTap: _controller.restoreBackup,
                ),
              ),

              const SizedBox(height: 8),

              // 3. ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ù†ØµÙŠ
              Card(
                elevation: 2,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                child: ListTile(
                  leading: const Icon(Icons.description, color: Colors.blue),
                  title: const Text('ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ù†ØµÙŠ'),
                  subtitle: const Text('Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª'),
                  trailing: Obx(() => _controller.isLoading.value
                      ? const SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(strokeWidth: 2),
                        )
                      : const Icon(Icons.chevron_right)),
                  onTap: _controller.exportSimpleBackup,
                ),
              ),

              const SizedBox(height: 24),

              // Ù‚Ø³Ù… Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ù…Ù‡Ù…Ø©
              const Text(
                'ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ù…Ù‡Ù…Ø©',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                ),
              ),
              const SizedBox(height: 12),

              Card(
                elevation: 2,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Padding(
                  padding: EdgeInsets.all(16),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      TipsRow(
                        icon: Icons.schedule,
                        text: 'Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹',
                      ),
                      SizedBox(height: 8),
                      TipsRow(
                        icon: Icons.folder,
                        text: 'Ø§Ø­ÙØ¸ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†',
                      ),
                      SizedBox(height: 8),
                      TipsRow(
                        icon: Icons.security,
                        text: 'Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†',
                      ),
                      SizedBox(height: 8),
                      TipsRow(
                        icon: Icons.devices,
                        text: 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¹Ù„Ù‰ Ø£ÙŠ Ø¬Ù‡Ø§Ø²',
                      ),
                    ],
                  ),
                ),
              ),

              const SizedBox(height: 24),

              // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
              FutureBuilder<int>(
                future: _controller.getBackupFileCount(),
                builder: (context, snapshot) {
                  if (snapshot.connectionState == ConnectionState.waiting) {
                    return const Center(child: CircularProgressIndicator());
                  }

                  final fileCount = snapshot.data ?? 0;

                  return Card(
                    elevation: 2,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16),
                      child: Column(
                        children: [
                          const Row(
                            children: [
                              Icon(Icons.analytics, color: Colors.purple),
                              SizedBox(width: 8),
                              Text(
                                'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ',
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 12),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceAround,
                            children: [
                              _buildStatItem(
                                'Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø³Ø®',
                                fileCount.toString(),
                                Icons.folder,
                                Colors.blue,
                              ),
                              Obx(() => _buildStatItem(
                                    'Ø¢Ø®Ø± Ù†Ø³Ø®Ø©',
                                    _controller.lastBackupDate.value != null
                                        ? DateFormat('MM/dd').format(
                                            _controller.lastBackupDate.value!)
                                        : '--',
                                    Icons.calendar_today,
                                    Colors.green,
                                  )),
                            ],
                          ),
                        ],
                      ),
                    ),
                  );
                },
              ),

              const SizedBox(height: 24),

              // Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ù†ÙŠØ©
              Container(
                width: double.infinity,
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.orange[50],
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: Colors.orange[200]!),
                ),
                child: Row(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Icon(Icons.security, color: Colors.orange, size: 24),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ù†ÙŠØ© Ù…Ù‡Ù…Ø©',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              color: Colors.orange,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            'Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙˆÙ„Ø§ ÙŠØªÙ… Ø±ÙØ¹Ù‡Ø§ Ù„Ø£ÙŠ Ù…ÙƒØ§Ù†. ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†.',
                            style: TextStyle(
                              fontSize: 12,
                              color: Colors.grey[700],
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©
              OutlinedButton.icon(
                onPressed: () {
                  _showAdvancedOptions();
                },
                icon: const Icon(Icons.settings),
                label: const Text('Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©'),
                style: OutlinedButton.styleFrom(
                  minimumSize: const Size(double.infinity, 48),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
              ),

              const SizedBox(height: 32),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildStatItem(
      String title, String value, IconData icon, Color color) {
    return Column(
      children: [
        Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: color.withOpacity(0.1),
            shape: BoxShape.circle,
          ),
          child: Icon(icon, color: color, size: 20),
        ),
        const SizedBox(height: 8),
        Text(
          title,
          style: const TextStyle(
            fontSize: 12,
            color: Colors.grey,
          ),
        ),
        Text(
          value,
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.bold,
            color: color,
          ),
        ),
      ],
    );
  }

  void _showAdvancedOptions() {
    Get.bottomSheet(
      Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: Get.isDarkMode ? Colors.grey[900] : Colors.white,
          borderRadius: const BorderRadius.only(
            topLeft: Radius.circular(20),
            topRight: Radius.circular(20),
          ),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Center(
              child: Container(
                width: 40,
                height: 5,
                decoration: BoxDecoration(
                  color: Colors.grey[300],
                  borderRadius: BorderRadius.circular(3),
                ),
              ),
            ),
            const SizedBox(height: 20),
            const Text(
              'Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 16),

            // Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
            ListTile(
              leading: const Icon(Icons.delete, color: Colors.red),
              title: const Text('Ù…Ø³Ø­ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ'),
              subtitle: const Text('Ø­Ø°Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©'),
              onTap: () {
                Get.back();
                _controller.clearBackupData();
              },
            ),

            ListTile(
              leading: const Icon(Icons.info, color: Colors.blue),
              title: const Text('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ù†Ø¸Ø§Ù…'),
              subtitle: const Text('Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'),
              onTap: () {
                Get.back();
                _showSystemInfo();
              },
            ),

            const SizedBox(height: 20),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: Get.back,
                child: const Text('Ø¥ØºÙ„Ø§Ù‚'),
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _showSystemInfo() {
    Get.dialog(
      AlertDialog(
        title: const Text('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…'),
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text(
                'ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠ',
                style: TextStyle(fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 8),
              const Text('â€¢ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ³ØªØ®Ø¯Ù… GetStorage Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ'),
              const Text('â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ÙØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… AES-256'),
              const Text('â€¢ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© ØªØ®Ø²Ù† ÙÙŠ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'),
              const SizedBox(height: 16),
              const Text(
                'Ø§Ù„ØªÙˆØ§ÙÙ‚',
                style: TextStyle(fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 8),
              const Text('â€¢ ØªØ¯Ø¹Ù… Android Ùˆ iOS'),
              const Text('â€¢ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¹Ù„Ù‰ Ø£ÙŠ Ø¬Ù‡Ø§Ø²'),
              const Text('â€¢ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: JSON'),
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: Get.back,
            child: const Text('Ø­Ø³Ù†Ø§Ù‹'),
          ),
        ],
      ),
    );
  }
}

// ÙˆÙŠØ¯Ø¬Øª Ù„ØµÙÙˆÙ Ø§Ù„Ù†ØµØ§Ø¦Ø­
class TipsRow extends StatelessWidget {
  final IconData icon;
  final String text;

  const TipsRow({
    super.key,
    required this.icon,
    required this.text,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Icon(icon, size: 20, color: Colors.blue),
        const SizedBox(width: 12),
        Expanded(
          child: Text(
            text,
            style: const TextStyle(fontSize: 14),
          ),
        ),
      ],
    );
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\domain\entities\expense_entity.dart ===== 
// lib/features/expense/domain/entities/expense_entity.dart

import 'dart:convert'; // âœ… For UTF-8 encoding/decoding
import 'package:uuid/uuid.dart';
import '../../../../core/models/enums.dart';
import '../../../../core/utils/error_handler.dart';

class ExpenseEntity {
  final String id;
  final double amount;
  final ExpenseCategory category;
  final String description; // âœ… Arabic-safe string
  final DateTime date;
  final bool isIncome;
  final String? receiptImage;
  final PaymentMethod paymentMethod;

  ExpenseEntity({
    String? id,
    required this.amount,
    required this.category,
    required this.description,
    required this.date,
    required this.isIncome,
    this.receiptImage,
    required this.paymentMethod,
  })  : id = id ?? const Uuid().v4(),
        assert(amount > 0, 'Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');

  ExpenseEntity copyWith({
    String? id,
    double? amount,
    ExpenseCategory? category,
    String? description,
    DateTime? date,
    bool? isIncome,
    String? receiptImage,
    PaymentMethod? paymentMethod,
  }) {
    return ExpenseEntity(
      id: id ?? this.id,
      amount: amount ?? this.amount,
      category: category ?? this.category,
      description: description ?? this.description,
      date: date ?? this.date,
      isIncome: isIncome ?? this.isIncome,
      receiptImage: receiptImage ?? this.receiptImage,
      paymentMethod: paymentMethod ?? this.paymentMethod,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'amount': amount,
      'category': category.arabicName,
      // âœ… Ensure Arabic text is UTF-8 safe
      'description': utf8.decode(utf8.encode(description.trim())),
      'date': date.toIso8601String(),
      'isIncome': isIncome,
      'receiptImage': receiptImage,
      'paymentMethod': paymentMethod.arabicName,
    };
  }

  factory ExpenseEntity.fromMap(Map<String, dynamic> map) {
    try {
      final categoryStr = map['category']?.toString() ?? 'Ø£Ø®Ø±Ù‰';
      final paymentMethodStr = map['paymentMethod']?.toString() ?? 'Ù†Ù‚Ø¯ÙŠ';
      final descriptionStr = map['description']?.toString().trim() ?? '';
      final amountValue = map['amount'];

      return ExpenseEntity(
        id: map['id']?.toString() ?? const Uuid().v4(),
        amount: _parseAmount(amountValue),
        category: ExpenseCategory.fromString(categoryStr),
        description: utf8.decode(utf8.encode(descriptionStr)), // âœ… Arabic-safe
        date: _parseDate(map['date']?.toString()),
        isIncome: _parseBoolean(map['isIncome']),
        receiptImage: map['receiptImage']?.toString(),
        paymentMethod: PaymentMethod.fromString(paymentMethodStr),
      );
    } catch (e, stackTrace) {
      print('âŒ Error in ExpenseEntity.fromMap: $e');
      print('Map data: $map');

      return ExpenseEntity(
        amount: 0.0,
        category: ExpenseCategory.other,
        description: 'Ù…Ø¹Ø§Ù…Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©',
        date: DateTime.now(),
        isIncome: false,
        paymentMethod: PaymentMethod.cash,
      );
    }
  }

  static double _parseAmount(dynamic amountValue) {
    try {
      if (amountValue == null) return 0.0;
      if (amountValue is int) return amountValue.toDouble();
      if (amountValue is double) return amountValue;
      if (amountValue is String) return double.tryParse(amountValue) ?? 0.0;
      if (amountValue is num) return amountValue.toDouble();
      return 0.0;
    } catch (e) {
      print('Error parsing amount: $amountValue, error: $e');
      return 0.0;
    }
  }

  static DateTime _parseDate(String? dateString) {
    try {
      if (dateString == null || dateString.isEmpty) {
        return DateTime.now();
      }
      return DateTime.parse(dateString);
    } catch (e) {
      print('Error parsing date: $dateString, error: $e');
      return DateTime.now();
    }
  }

  static bool _parseBoolean(dynamic value) {
    try {
      if (value == null) return false;
      if (value is bool) return value;
      if (value is String) return value.toLowerCase() == 'true';
      if (value is int) return value > 0;
      return false;
    } catch (e) {
      print('Error parsing boolean: $value, error: $e');
      return false;
    }
  }

  @override
  String toString() {
    return 'ExpenseEntity(id: $id, amount: $amount, category: ${category.arabicName}, description: $description, date: $date, isIncome: $isIncome, paymentMethod: ${paymentMethod.arabicName})';
  }

  double get signedAmount => isIncome ? amount : -amount;

  bool isSimilarTo(ExpenseEntity other) {
    return amount == other.amount &&
        category == other.category &&
        description.trim() == other.description.trim() &&
        date.difference(other.date).inDays.abs() < 7;
  }

  @override
  bool operator ==(Object other) {
    if (identical(this, other)) return true;
    return other is ExpenseEntity && other.id == id;
  }

  @override
  int get hashCode => id.hashCode;
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\presentation\bindings\expense_binding.dart ===== 
// lib/features/expense/presentation/bindings/expense_binding.dart
import 'package:get/get.dart';

import '../controllers/expense_controller.dart';

class ExpenseBinding implements Bindings {
  @override
  void dependencies() {
    Get.lazyPut(() => ExpenseController());
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\presentation\controllers\budget_controller.dart ===== 
import 'package:get/get.dart';
import 'package:get_storage/get_storage.dart';
import 'package:finance_app/features/expense/presentation/controllers/expense_controller.dart';
import 'package:finance_app/core/security/simple_encryption.dart';

class BudgetController extends GetxController {
  final _storage = GetStorage();

  // Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
  final monthlyBudget = 0.0.obs;

  // Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø§Øª
  final categoryBudgets = <String, double>{}.obs;

  // Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
  final List<String> defaultCategories = [
    'Ø·Ø¹Ø§Ù…',
    'Ù…ÙˆØ§ØµÙ„Ø§Øª',
    'ØªØ³ÙˆÙ‚',
    'ØªØ±ÙÙŠÙ‡',
    'ØµØ­Ø©',
    'ØªØ¹Ù„ÙŠÙ…',
    'Ø³ÙƒÙ†',
    'ÙÙˆØ§ØªÙŠØ±',
  ];

  @override
  void onInit() {
    super.onInit();
    loadBudgetData();
  }

  // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
  Future<void> loadBudgetData() async {
    try {
      // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… SimpleEncryption Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
      final storedMonthlyBudget = SimpleEncryption.read('monthlyBudget');
      monthlyBudget.value = (storedMonthlyBudget as num?)?.toDouble() ?? 0.0;

      // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… SimpleEncryption Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„ÙØ¦Ø§Øª
      final storedCategoryBudgets =
          SimpleEncryption.read('categoryBudgets') ?? {};
      categoryBudgets.value = Map<String, double>.from(storedCategoryBudgets);

      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙØ¦Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
      if (categoryBudgets.isEmpty) {
        for (var category in defaultCategories) {
          categoryBudgets[category] = 0.0;
        }
      }

      print('âœ… Budget data loaded successfully');
    } catch (e) {
      print('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: $e');
      _initializeDefaultBudgets();
    }
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  void _initializeDefaultBudgets() {
    for (var category in defaultCategories) {
      categoryBudgets[category] = 0.0;
    }
    monthlyBudget.value = 0.0;
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
  Future<void> setMonthlyBudget(double amount) async {
    monthlyBudget.value = amount;

    // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… SimpleEncryption Ù„Ø­ÙØ¸ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
    await SimpleEncryption.write('monthlyBudget', amount);

    update();
    print('ğŸ’° Monthly budget updated: $amount');
  }

  // ØªØ­Ø¯ÙŠØ« Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙØ¦Ø© Ù…Ø­Ø¯Ø¯Ø©
  Future<void> setCategoryBudget(String category, double amount) async {
    categoryBudgets[category] = amount;
    await _saveCategoryBudgets();
    update();
    print('ğŸ“Š Category budget updated: $category = $amount');
  }

  // Ø­ÙØ¸ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„ÙØ¦Ø§Øª
  Future<void> _saveCategoryBudgets() async {
    // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… SimpleEncryption Ù„Ø­ÙØ¸ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„ÙØ¦Ø§Øª
    await SimpleEncryption.write('categoryBudgets', categoryBudgets);
  }

  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±...
  double get totalCategoryBudgets {
    return categoryBudgets.values.fold(0.0, (sum, budget) => sum + budget);
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
  double get remainingBudget {
    final expenseController = Get.find<ExpenseController>();
    return monthlyBudget.value - expenseController.totalExpense.value;
  }

  // Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
  double get spendingPercentage {
    if (monthlyBudget.value <= 0) return 0;
    final expenseController = Get.find<ExpenseController>();
    return (expenseController.totalExpense.value / monthlyBudget.value) * 100;
  }

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„ÙƒÙ„ ÙØ¦Ø©
  Map<String, double> getRemainingCategoryBudgets() {
    final expenseController = Get.find<ExpenseController>();
    final categoryExpenses = expenseController.getExpensesByCategory(false);

    final Map<String, double> remaining = {};

    for (var category in categoryBudgets.keys) {
      final budget = categoryBudgets[category] ?? 0.0;
      final spent = categoryExpenses[category] ?? 0.0;
      remaining[category] = budget - spent;
    }

    return remaining;
  }

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ø°ÙŠØ±Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
  List<String> getBudgetAlerts() {
    final List<String> alerts = [];
    final expenseController = Get.find<ExpenseController>();

    // ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    if (spendingPercentage >= 80) {
      alerts.add(
          'âš ï¸ Ø£Ù†Øª Ø£Ù†ÙÙ‚Øª ${spendingPercentage.toStringAsFixed(0)}% Ù…Ù† Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ');
    }

    if (spendingPercentage >= 100) {
      alerts.add('ğŸš¨ ØªØ¬Ø§ÙˆØ²Øª Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©!');
    }

    // ØªØ­Ø°ÙŠØ±Ø§Øª Ø§Ù„ÙØ¦Ø§Øª
    final remainingBudgets = getRemainingCategoryBudgets();
    for (var entry in remainingBudgets.entries) {
      if (entry.value < 0) {
        alerts.add(
            'ğŸ“Œ ØªØ¬Ø§ÙˆØ²Øª Ù…ÙŠØ²Ø§Ù†ÙŠØ© "${entry.key}" Ø¨Ù…Ù‚Ø¯Ø§Ø± ${entry.value.abs().toStringAsFixed(2)} Ø¬.Ù…');
      }
    }

    return alerts;
  }

  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
  Future<void> resetBudget() async {
    try {
      monthlyBudget.value = 0.0;
      categoryBudgets.clear();
      _initializeDefaultBudgets();

      // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… SimpleEncryption Ù„Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
      await SimpleEncryption.remove('monthlyBudget');
      await SimpleEncryption.remove('categoryBudgets');

      // Alternative: You can also write null values
      // await SimpleEncryption.write('monthlyBudget', null);
      // await SimpleEncryption.write('categoryBudgets', null);

      update();
      print('ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©');
    } catch (e) {
      print('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: $e');
      // Fallback: Reset in memory even if storage fails
      monthlyBudget.value = 0.0;
      categoryBudgets.clear();
      _initializeDefaultBudgets();
      update();
    }
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\presentation\controllers\expense_controller.dart ===== 
// lib/features/expense/presentation/controllers/expense_controller.dart

// import 'dart:convert'; //  For UTF-8 encoding supporting
import 'package:finance_app/core/models/enums.dart';
import 'package:finance_app/features/alerts/presentation/controllers/alert_controller.dart';
import 'package:finance_app/features/expense/domain/entities/expense_entity.dart';
import 'package:finance_app/core/utils/error_handler.dart';
import 'package:finance_app/core/security/simple_encryption.dart';
import 'package:finance_app/features/expense/presentation/controllers/budget_controller.dart';
import 'package:get/get.dart';
import 'package:flutter/material.dart';

class ExpenseController extends GetxController {
  final expenses = <ExpenseEntity>[].obs;
  final isLoading = false.obs;
  final totalIncome = 0.0.obs;
  final totalExpense = 0.0.obs;
  final balance = 0.0.obs;
  final selectedExpense = Rx<ExpenseEntity?>(null);

  @override
  void onInit() {
    super.onInit();
    _initializeData();
  }

  Future<void> _initializeData() async {
    isLoading.value = true;

    try {
      await loadExpenses();

      // Only add test data if absolutely no expenses exist
      if (expenses.isEmpty) {
        print('ğŸ“ No expenses found, considering test data...');
        // You might want to make this configurable or remove in production
        // await addTestData();
      }
    } catch (e, stackTrace) {
      print('âŒ Error initializing data: $e');
      print('Stack trace: $stackTrace');
      ErrorHandler.showError('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.toString()}');
    } finally {
      isLoading.value = false;
    }
  }

  Future<void> loadExpenses() async {
    try {
      final storedData = SimpleEncryption.read('expenses');

      if (storedData == null) {
        expenses.value = [];
        calculateRealTotals();
        print('ğŸ“­ No stored expenses found');
        return;
      }

      if (storedData is List) {
        final loadedExpenses = <ExpenseEntity>[];
        int errorCount = 0;
        int successCount = 0;

        for (var i = 0; i < storedData.length; i++) {
          try {
            final item = storedData[i];

            if (item is Map<String, dynamic>) {
              final expense = ExpenseEntity.fromMap(item);

              // Validate the loaded expense
              if (expense.amount > 0 && expense.id.isNotEmpty) {
                loadedExpenses.add(expense);
                successCount++;
              } else {
                print('âš ï¸ Skipping invalid expense at index $i');
                errorCount++;
              }
            } else {
              print('âš ï¸ Skipping non-map item at index $i: $item');
              errorCount++;
            }
          } catch (e, stackTrace) {
            print('âŒ Error parsing expense at index $i: $e');
            print('Stack trace: $stackTrace');
            errorCount++;
          }
        }

        expenses.value = loadedExpenses;
        calculateRealTotals();

        print('ğŸ“Š Loaded $successCount expenses with $errorCount errors');

        if (errorCount > 0) {
          ErrorHandler.showWarning(
            'ØªÙ… ØªØ­Ù…ÙŠÙ„ $successCount Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø¹ $errorCount Ø£Ø®Ø·Ø§Ø¡',
            title: 'Ù…Ù„Ø§Ø­Ø¸Ø©',
          );
        }
      } else {
        print('âš ï¸ Stored expenses is not a List: ${storedData.runtimeType}');
        expenses.value = [];
        calculateRealTotals();

        // Try to recover by clearing corrupted data
        await SimpleEncryption.remove('expenses');
        ErrorHandler.showWarning(
          'ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ù„ÙØ©ØŒ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©',
          title: 'ØªÙ†Ø¨ÙŠÙ‡',
        );
      }
    } catch (e, stackTrace) {
      print('âŒ Critical error loading expenses: $e');
      print('Stack trace: $stackTrace');

      expenses.value = [];
      calculateRealTotals();

      ErrorHandler.showError(
        'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
        title: 'Ø®Ø·Ø£ Ø­Ø±Ø¬',
      );
    }
  }

  // Marked as @visibleForTesting - remove or disable in production
  @visibleForTesting
  Future<void> addTestData() async {
    try {
      final testExpenses = [
        ExpenseEntity(
          amount: 5000.0,
          category: ExpenseCategory.salary,
          description: 'Ù…Ø±ØªØ¨ Ø´Ù‡Ø± ÙŠÙ†Ø§ÙŠØ±',
          date: DateTime.now(),
          isIncome: true,
          paymentMethod: PaymentMethod.bankTransfer,
        ),
        ExpenseEntity(
          amount: 300.0,
          category: ExpenseCategory.food,
          description: 'Ø³ÙˆÙ‚ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
          date: DateTime.now(),
          isIncome: false,
          paymentMethod: PaymentMethod.cash,
        ),
        ExpenseEntity(
          amount: 150.0,
          category: ExpenseCategory.transportation,
          description: 'Ø¨Ù†Ø²ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©',
          date: DateTime.now(),
          isIncome: false,
          paymentMethod: PaymentMethod.creditCard,
        ),
      ];

      expenses.value = testExpenses;
      await _saveToStorage();
      calculateRealTotals();

      ErrorHandler.showSuccess('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
    } catch (e, stackTrace) {
      print('âŒ Error adding test data: $e');
      print('Stack trace: $stackTrace');
      ErrorHandler.showError(
          'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©: ${e.toString()}');
    }
  }

  void calculateRealTotals() {
    double income = 0;
    double expense = 0;

    for (var entity in expenses) {
      if (entity.isIncome) {
        income += entity.amount;
      } else {
        expense += entity.amount;
      }
    }

    totalIncome.value = income;
    totalExpense.value = expense;
    balance.value = income - expense;

    print(
        'ğŸ’° Totals calculated - Income: $income, Expense: $expense, Balance: ${balance.value}');
  }

  Future<void> addExpense(ExpenseEntity expense) async {
    try {
      // Enhanced validation
      if (expense.amount <= 0) {
        throw Exception('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
      }

      if (expense.category == ExpenseCategory.other &&
          expense.description.isEmpty) {
        throw Exception('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙØ¦Ø© "Ø£Ø®Ø±Ù‰"');
      }

      // Check for duplicates (optional feature)
      if (_isDuplicateExpense(expense)) {
        final shouldProceed = await ErrorHandler.showConfirmationDialog(
          title: 'Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø´Ø§Ø¨Ù‡Ø©',
          message: 'ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø´Ø§Ø¨Ù‡Ø© ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ø¤Ø®Ø±Ø§Ù‹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',
          confirmText: 'Ù†Ø¹Ù…ØŒ Ù…ØªØ§Ø¨Ø¹Ø©',
          cancelText: 'Ø¥Ù„ØºØ§Ø¡',
          confirmColor: Colors.blue,
        );

        if (!shouldProceed) {
          return;
        }
      }

      expenses.add(expense);
      await _saveToStorage();
      calculateRealTotals();

      ErrorHandler.showSuccess('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');

      // Trigger alerts if enabled
      final alertController = Get.find<AlertController>();
      alertController.checkExpenseAlerts(
          expense.amount, expense.category.arabicName);

      if (Get.isRegistered<BudgetController>()) {
        final budgetController = Get.find<BudgetController>();
        alertController.checkBudgetAlerts(
          budgetController.spendingPercentage,
          budgetController.remainingBudget,
        );
      }
    } catch (e, stackTrace) {
      print('âŒ Error adding expense: $e');
      print('Stack trace: $stackTrace');

      ErrorHandler.showError('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${e.toString()}');
      rethrow;
    }
  }

  bool _isDuplicateExpense(ExpenseEntity newExpense) {
    final recentExpenses = this.recentExpenses.take(5).toList();

    for (var existingExpense in recentExpenses) {
      if (existingExpense.isSimilarTo(newExpense)) {
        return true;
      }
    }

    return false;
  }

  Future<void> updateExpense(int index, ExpenseEntity expense) async {
    try {
      if (index < 0 || index >= expenses.length) {
        throw Exception('ÙÙ‡Ø±Ø³ ØºÙŠØ± ØµØ§Ù„Ø­');
      }

      // Validate the expense
      if (expense.amount <= 0) {
        throw Exception('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
      }

      expenses[index] = expense;
      await _saveToStorage();
      calculateRealTotals();

      ErrorHandler.showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
    } catch (e, stackTrace) {
      print('âŒ Error updating expense at index $index: $e');
      print('Stack trace: $stackTrace');

      ErrorHandler.showError('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${e.toString()}');
    }
  }

  Future<void> deleteExpense(int index) async {
    try {
      if (index < 0 || index >= expenses.length) {
        throw Exception('ÙÙ‡Ø±Ø³ ØºÙŠØ± ØµØ§Ù„Ø­');
      }

      // Get expense details for confirmation
      final expenseToDelete = expenses[index];

      expenses.removeAt(index);
      await _saveToStorage();
      calculateRealTotals();

      ErrorHandler.showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');

      // Log the deletion (for analytics or audit trail)
      print(
          'ğŸ—‘ï¸ Deleted expense: ${expenseToDelete.category.arabicName} - ${expenseToDelete.amount}');
    } catch (e, stackTrace) {
      print('âŒ Error deleting expense at index $index: $e');
      print('Stack trace: $stackTrace');

      ErrorHandler.showError('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${e.toString()}');
    }
  }

  Future<void> clearAllData() async {
    try {
      final confirmed = await ErrorHandler.showConfirmationDialog(
        title: 'Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        message:
            'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§ØªØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡ ÙˆØ³ÙŠØªÙ… Ø­Ø°Ù:\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª\n\nØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.',
        confirmText: 'Ù†Ø¹Ù…ØŒ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„',
        cancelText: 'Ø¥Ù„ØºØ§Ø¡',
        confirmColor: Colors.red,
      );

      if (!confirmed) {
        print('âš ï¸ User cancelled clear all data');
        return;
      }

      expenses.clear();
      await SimpleEncryption.remove('expenses');

      // Also clear other related data
      await SimpleEncryption.remove('monthlyBudget');
      await SimpleEncryption.remove('categoryBudgets');

      calculateRealTotals();

      ErrorHandler.showSuccess('ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');

      print('ğŸ§¹ All data cleared by user');
    } catch (e, stackTrace) {
      print('âŒ Error clearing all data: $e');
      print('Stack trace: $stackTrace');

      ErrorHandler.showError('ÙØ´Ù„ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.toString()}');
    }
  }

  Future<void> _saveToStorage() async {
    try {
      final data = expenses.map((e) => e.toMap()).toList();
      await SimpleEncryption.write('expenses', data);

      print('ğŸ’¾ Saved ${expenses.length} expenses to storage');
    } catch (e, stackTrace) {
      print('âŒ Error saving expenses to storage: $e');
      print('Stack trace: $stackTrace');

      ErrorHandler.showError('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.toString()}');
      rethrow;
    }
  }

  Map<String, dynamic> getMonthlyStats() {
    final now = DateTime.now();
    final monthlyExpenses = expenses.where((expense) {
      return expense.date.month == now.month && expense.date.year == now.year;
    }).toList();

    double monthlyIncome = 0;
    double monthlyExpense = 0;

    for (var expense in monthlyExpenses) {
      if (expense.isIncome) {
        monthlyIncome += expense.amount;
      } else {
        monthlyExpense += expense.amount;
      }
    }

    return {
      'income': monthlyIncome,
      'expense': monthlyExpense,
      'balance': monthlyIncome - monthlyExpense,
      'count': monthlyExpenses.length,
      'averageExpense': monthlyExpenses.isNotEmpty
          ? monthlyExpense / monthlyExpenses.length
          : 0,
    };
  }

  Map<String, double> getExpensesByCategory(bool isIncome) {
    final Map<String, double> categoryTotals = {};

    final filteredExpenses =
        expenses.where((expense) => expense.isIncome == isIncome);

    for (var expense in filteredExpenses) {
      final categoryName = expense.category.arabicName;
      categoryTotals.update(
        categoryName,
        (value) => value + expense.amount,
        ifAbsent: () => expense.amount,
      );
    }

    return categoryTotals;
  }

  int get expenseCount => expenses.length;

  List<ExpenseEntity> get recentExpenses {
    final sorted = List<ExpenseEntity>.from(expenses);
    sorted.sort((a, b) => b.date.compareTo(a.date));
    return sorted;
  }

  List<ExpenseEntity> getExpensesByDateRange(DateTime start, DateTime end) {
    return expenses.where((expense) {
      return expense.date.isAfter(start.subtract(const Duration(days: 1))) &&
          expense.date.isBefore(end.add(const Duration(days: 1)));
    }).toList();
  }

  ExpenseEntity? getExpenseById(String id) {
    try {
      return expenses.firstWhere((expense) => expense.id == id);
    } catch (e) {
      return null;
    }
  }

  List<Map<String, dynamic>> get expensesAsMap {
    return expenses.map((e) => e.toMap()).toList();
  }

  /// Get expenses for the current month
  List<ExpenseEntity> get currentMonthExpenses {
    final now = DateTime.now();
    return expenses.where((expense) {
      return expense.date.month == now.month && expense.date.year == now.year;
    }).toList();
  }

  /// Get the most expensive category
  String? get mostExpensiveCategory {
    if (expenses.isEmpty) return null;

    final categoryTotals = getExpensesByCategory(false);
    if (categoryTotals.isEmpty) return null;

    final sortedEntries = categoryTotals.entries.toList()
      ..sort((a, b) => b.value.compareTo(a.value));

    return sortedEntries.first.key;
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\presentation\pages\add_expense_page.dart ===== 
import 'dart:ui' as ui;
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:intl/intl.dart';

import '../../../../core/models/enums.dart';
import '../../domain/entities/expense_entity.dart';
import '../controllers/expense_controller.dart';

class AddExpensePage extends StatefulWidget {
  const AddExpensePage({super.key});

  @override
  State<AddExpensePage> createState() => _AddExpensePageState();
}

class _AddExpensePageState extends State<AddExpensePage> {
  final ExpenseController _controller = Get.find();
  final _formKey = GlobalKey<FormState>();

  double _amount = 0.0;
  String _category = 'Ø·Ø¹Ø§Ù…';
  String _description = '';
  DateTime _date = DateTime.now();
  bool _isIncome = false;
  String _paymentMethod = 'Ù†Ù‚Ø¯ÙŠ';

  final _amountController = TextEditingController();
  final _descriptionController = TextEditingController();

  final List<String> _categories = [
    'Ø·Ø¹Ø§Ù…',
    'Ù…ÙˆØ§ØµÙ„Ø§Øª',
    'ØªØ³ÙˆÙ‚',
    'ØªØ±ÙÙŠÙ‡',
    'ØµØ­Ø©',
    'ØªØ¹Ù„ÙŠÙ…',
    'Ø³ÙƒÙ†',
    'ÙÙˆØ§ØªÙŠØ±',
    'Ù…Ø±ØªØ¨',
    'Ø§Ø³ØªØ«Ù…Ø§Ø±',
    'Ù‡Ø¯Ø§ÙŠØ§',
    'Ø£Ø®Ø±Ù‰'
  ];

  final List<String> _paymentMethods = [
    'Ù†Ù‚Ø¯ÙŠ',
    'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†',
    'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ',
    'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©',
    'Ø´ÙŠÙƒ'
  ];

  @override
  void dispose() {
    _amountController.dispose();
    _descriptionController.dispose();
    super.dispose();
  }

  String _formatDate(DateTime date) {
    try {
      return DateFormat('yyyy/MM/dd', 'ar').format(date);
    } catch (_) {
      return DateFormat('yyyy/MM/dd').format(date);
    }
  }

  // âœ… **Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØµØ­Ø­Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®**
  Future<DateTime?> _selectDate(BuildContext context) async {
    try {
      print('ğŸ“… Opening date picker...');

      final DateTime? picked = await showDatePicker(
        context: context,
        initialDate: _date,
        firstDate: DateTime(2000),
        lastDate: DateTime(2100),
        locale: const Locale('ar'), // âœ… ÙÙ‚Ø· 'ar' Ø¨Ø¯ÙˆÙ† 'EG'
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ builder Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
      );

      if (picked != null) {
        print('ğŸ“… Selected: $picked');
      } else {
        print('ğŸ“… Date selection cancelled');
      }

      return picked;
    } catch (e) {
      print('âŒ Date picker error: $e');
      return null;
    }
  }

  @override
  Widget build(BuildContext context) {
    return Directionality(
      textDirection: ui.TextDirection.rtl,
      child: Scaffold(
        appBar: AppBar(
          title: Text(_isIncome ? 'Ø¥Ø¶Ø§ÙØ© Ø¯Ø®Ù„ Ø¬Ø¯ÙŠØ¯' : 'Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯'),
          centerTitle: true,
        ),
        body: Form(
          key: _formKey,
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(20),
            child: Column(
              children: [
                // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø®Ù„/Ø§Ù„Ù…ØµØ±ÙˆÙ
                SwitchListTile(
                  title: Text(_isIncome ? 'Ø¯Ø®Ù„' : 'Ù…ØµØ±ÙˆÙ'),
                  value: _isIncome,
                  onChanged: (v) => setState(() => _isIncome = v),
                ),
                const SizedBox(height: 16),

                // Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº
                TextFormField(
                  controller: _amountController,
                  keyboardType: TextInputType.number,
                  decoration: const InputDecoration(
                    labelText: 'Ø§Ù„Ù…Ø¨Ù„Øº',
                    border: OutlineInputBorder(),
                  ),
                  validator: (v) => v == null || double.tryParse(v) == null
                      ? 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§'
                      : null,
                  onSaved: (v) => _amount = double.parse(v!),
                ),
                const SizedBox(height: 16),

                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø©
                DropdownButtonFormField(
                  value: _category,
                  decoration: const InputDecoration(
                    labelText: 'Ø§Ù„ÙØ¦Ø©',
                    border: OutlineInputBorder(),
                  ),
                  items: _categories
                      .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                      .toList(),
                  onChanged: (v) => setState(() => _category = v!),
                ),
                const SizedBox(height: 16),

                // âœ… **Ø²Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ­Ø­**
                GestureDetector(
                  onTap: () async {
                    print('ğŸŸ¡ Date field tapped!');
                    final picked = await _selectDate(context);
                    if (picked != null) {
                      setState(() => _date = picked);
                    }
                  },
                  child: Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      border: Border.all(color: Colors.grey),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text(
                          'Ø§Ù„ØªØ§Ø±ÙŠØ®',
                          style: TextStyle(
                            color: Colors.grey[600],
                            fontSize: 16,
                          ),
                        ),
                        Row(
                          children: [
                            Text(
                              _formatDate(_date),
                              style: const TextStyle(fontSize: 16),
                            ),
                            const SizedBox(width: 8),
                            const Icon(Icons.calendar_today,
                                color: Colors.blue),
                          ],
                        ),
                      ],
                    ),
                  ),
                ),

                const SizedBox(height: 16),

                // Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
                DropdownButtonFormField(
                  value: _paymentMethod,
                  decoration: const InputDecoration(
                    labelText: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹',
                    border: OutlineInputBorder(),
                  ),
                  items: _paymentMethods
                      .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                      .toList(),
                  onChanged: (v) => setState(() => _paymentMethod = v!),
                ),
                const SizedBox(height: 16),

                // Ø­Ù‚Ù„ Ø§Ù„ÙˆØµÙ
                TextFormField(
                  controller: _descriptionController,
                  maxLines: 3,
                  decoration: const InputDecoration(
                    labelText: 'Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
                    border: OutlineInputBorder(),
                  ),
                  textDirection: ui.TextDirection.rtl,
                  textAlign: TextAlign.right,
                  onSaved: (v) => _description = v ?? '',
                ),
                const SizedBox(height: 24),

                // Ø²Ø± Ø§Ù„Ø­ÙØ¸
                ElevatedButton(
                  onPressed: _saveExpense,
                  style: ElevatedButton.styleFrom(
                    minimumSize: const Size(double.infinity, 50),
                  ),
                  child: const Text('Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©'),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  void _saveExpense() {
    if (!_formKey.currentState!.validate()) return;
    _formKey.currentState!.save();

    final expense = ExpenseEntity(
      amount: _amount,
      category: ExpenseCategory.fromString(_category),
      description: _description,
      date: _date,
      isIncome: _isIncome,
      paymentMethod: PaymentMethod.fromString(_paymentMethod),
    );

    _controller.addExpense(expense);
    Get.back();
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\presentation\pages\budget_page.dart ===== 
// lib/features/budget/presentation/pages/budget_page.dart

import 'package:finance_app/features/expense/presentation/controllers/expense_controller.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:get_storage/get_storage.dart';
import '../controllers/budget_controller.dart';

class BudgetPage extends StatefulWidget {
  const BudgetPage({super.key});

  @override
  State<BudgetPage> createState() => _BudgetPageState();
}

class _BudgetPageState extends State<BudgetPage> {
  final BudgetController _controller = Get.find();
  final ExpenseController _expenseController = Get.find();

  final TextEditingController _budgetController = TextEditingController();
  final Map<String, TextEditingController> _categoryControllers = {};

  @override
  void initState() {
    super.initState();
    _budgetController.text = _controller.monthlyBudget.value.toStringAsFixed(2);

    // ØªÙ‡ÙŠØ¦Ø© controllers Ù„Ù„ÙØ¦Ø§Øª
    for (var category in _controller.defaultCategories) {
      _categoryControllers[category] = TextEditingController(
        text:
            _controller.categoryBudgets[category]?.toStringAsFixed(2) ?? '0.00',
      );
    }
  }

  @override
  void dispose() {
    _budgetController.dispose();
    for (var controller in _categoryControllers.values) {
      controller.dispose();
    }
    super.dispose();
  }

  void _saveMonthlyBudget() {
    final value = double.tryParse(_budgetController.text) ?? 0.0;
    _controller.setMonthlyBudget(value);
    Get.snackbar('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©');
  }

  void _saveCategoryBudget(String category) {
    final controller = _categoryControllers[category];
    final value = double.tryParse(controller?.text ?? '0') ?? 0.0;
    _controller.setCategoryBudget(category, value);
    Get.snackbar('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙŠØ²Ø§Ù†ÙŠØ© $category');
  }

  void _showBudgetSummary() {
    final alerts = _controller.getBudgetAlerts();

    Get.defaultDialog(
      title: 'Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
      content: SizedBox(
        width: double.maxFinite,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
            _buildSummaryItem(
              'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©',
              '${_controller.monthlyBudget.value} Ø¬.Ù…',
              Icons.account_balance_wallet,
              Colors.blue,
            ),

            _buildSummaryItem(
              'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚',
              '${_expenseController.totalExpense.value} Ø¬.Ù…',
              Icons.arrow_upward,
              Colors.red,
            ),

            _buildSummaryItem(
              'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ',
              '${_controller.remainingBudget.toStringAsFixed(2)} Ø¬.Ù…',
              Icons.savings,
              _controller.remainingBudget >= 0 ? Colors.green : Colors.red,
            ),

            const Divider(),

            // Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª
            if (alerts.isNotEmpty) ...[
              const Padding(
                padding: EdgeInsets.only(bottom: 8),
                child: Text(
                  'ØªØ­Ø°ÙŠØ±Ø§Øª:',
                  style: TextStyle(fontWeight: FontWeight.bold),
                ),
              ),
              ...alerts
                  .map((alert) => Padding(
                        padding: const EdgeInsets.symmetric(vertical: 4),
                        child: Text('â€¢ $alert'),
                      ))
                  .toList(),
            ],
          ],
        ),
      ),
      textConfirm: 'Ø­Ø³Ù†Ø§Ù‹',
      onConfirm: Get.back,
    );
  }

  Widget _buildSummaryItem(
      String title, String value, IconData icon, Color color) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        children: [
          Icon(icon, color: color, size: 24),
          const SizedBox(width: 12),
          Expanded(child: Text(title)),
          Text(
            value,
            style: TextStyle(
              fontWeight: FontWeight.bold,
              color: color,
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©'),
        centerTitle: true,
        actions: [
          IconButton(
            icon: const Icon(Icons.assessment),
            onPressed: _showBudgetSummary,
            tooltip: 'Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
          ),
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
            Card(
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 8),
                    TextField(
                      controller: _budgetController,
                      decoration: InputDecoration(
                        labelText: 'Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)',
                        prefixIcon: const Icon(Icons.attach_money),
                        suffixIcon: IconButton(
                          icon: const Icon(Icons.save),
                          onPressed: _saveMonthlyBudget,
                        ),
                      ),
                      keyboardType: TextInputType.number,
                    ),
                    const SizedBox(height: 16),
                    Obx(() {
                      final percentage = _controller.spendingPercentage;
                      return Column(
                        children: [
                          LinearProgressIndicator(
                            value: percentage / 100,
                            backgroundColor: Colors.grey[300],
                            valueColor: AlwaysStoppedAnimation<Color>(
                              percentage >= 100
                                  ? Colors.red
                                  : percentage >= 80
                                      ? Colors.orange
                                      : Colors.green,
                            ),
                            minHeight: 10,
                          ),
                          const SizedBox(height: 8),
                          Text(
                            'ØªÙ… Ø¥Ù†ÙØ§Ù‚ ${percentage.toStringAsFixed(1)}% Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
                            style: TextStyle(
                              color: percentage >= 100
                                  ? Colors.red
                                  : percentage >= 80
                                      ? Colors.orange
                                      : Colors.green,
                            ),
                          ),
                        ],
                      );
                    }),
                  ],
                ),
              ),
            ),

            const SizedBox(height: 24),

            // Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø§Øª
            Card(
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      'Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø§Øª',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 8),
                    const Text(
                      'Ø­Ø¯Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„ÙƒÙ„ ÙØ¦Ø© Ù…Ù† ÙØ¦Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                      style: TextStyle(color: Colors.grey),
                    ),
                    const SizedBox(height: 16),

                    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª
                    ..._controller.defaultCategories.map((category) {
                      return Padding(
                        padding: const EdgeInsets.symmetric(vertical: 8),
                        child: Row(
                          children: [
                            Expanded(
                              child: Text(category),
                            ),
                            SizedBox(
                              width: 120,
                              child: TextField(
                                controller: _categoryControllers[category],
                                decoration: InputDecoration(
                                  hintText: '0.00',
                                  suffixText: 'Ø¬.Ù…',
                                  contentPadding: const EdgeInsets.symmetric(
                                    horizontal: 12,
                                    vertical: 8,
                                  ),
                                ),
                                keyboardType: TextInputType.number,
                                onSubmitted: (_) =>
                                    _saveCategoryBudget(category),
                              ),
                            ),
                            IconButton(
                              icon: const Icon(Icons.save, size: 20),
                              onPressed: () => _saveCategoryBudget(category),
                            ),
                          ],
                        ),
                      );
                    }).toList(),
                  ],
                ),
              ),
            ),

            const SizedBox(height: 24),

            // Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            const Card(
              child: Padding(
                padding: EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    SizedBox(height: 8),
                    Text(
                      'â€¢ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØªØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ù†ÙØ§Ù‚Ùƒ',
                      style: TextStyle(color: Colors.grey),
                    ),
                    Text(
                      'â€¢ Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù…Ùƒ Ø¹Ù†Ø¯ Ø§Ù‚ØªØ±Ø§Ø¨Ùƒ Ù…Ù† ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
                      style: TextStyle(color: Colors.grey),
                    ),
                    Text(
                      'â€¢ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª',
                      style: TextStyle(color: Colors.grey),
                    ),
                  ],
                ),
              ),
            ),

            const SizedBox(height: 32),

            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
            Row(
              children: [
                Expanded(
                  child: ElevatedButton.icon(
                    onPressed: _showBudgetSummary,
                    icon: const Icon(Icons.assessment),
                    label: const Text('Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.blue,
                      foregroundColor: Colors.white,
                    ),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: OutlinedButton.icon(
                    onPressed: () {
                      _controller.resetBudget();
                      setState(() {
                        _budgetController.text = '0.00';
                        for (var controller in _categoryControllers.values) {
                          controller.text = '0.00';
                        }
                      });
                    },
                    icon: const Icon(Icons.restart_alt),
                    label: const Text('Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†'),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\presentation\pages\edit_expense_page.dart ===== 
// lib/features/expense/presentation/pages/edit_expense_page.dart

import 'dart:ui' as ui;
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:intl/intl.dart';

import '../../../../core/models/enums.dart';
import '../../../../features/expense/domain/entities/expense_entity.dart';
import '../controllers/expense_controller.dart';

class EditExpensePage extends StatefulWidget {
  final int expenseIndex;
  final Map<String, dynamic> expenseData;

  const EditExpensePage({
    super.key,
    required this.expenseIndex,
    required this.expenseData,
  });

  @override
  State<EditExpensePage> createState() => _EditExpensePageState();
}

class _EditExpensePageState extends State<EditExpensePage> {
  final ExpenseController _controller = Get.find();
  final _formKey = GlobalKey<FormState>();

  late double _amount;
  late String _category;
  late String _description;
  late DateTime _date;
  late bool _isIncome;
  late String _paymentMethod;

  final _amountController = TextEditingController();
  final _descriptionController = TextEditingController();

  final List<String> _categories = [
    'Ø·Ø¹Ø§Ù…',
    'Ù…ÙˆØ§ØµÙ„Ø§Øª',
    'ØªØ³ÙˆÙ‚',
    'ØªØ±ÙÙŠÙ‡',
    'ØµØ­Ø©',
    'ØªØ¹Ù„ÙŠÙ…',
    'Ø³ÙƒÙ†',
    'ÙÙˆØ§ØªÙŠØ±',
    'Ù…Ø±ØªØ¨',
    'Ø§Ø³ØªØ«Ù…Ø§Ø±',
    'Ù‡Ø¯Ø§ÙŠØ§',
    'Ø£Ø®Ø±Ù‰'
  ];

  final List<String> _paymentMethods = [
    'Ù†Ù‚Ø¯ÙŠ',
    'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†',
    'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ',
    'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©',
    'Ø´ÙŠÙƒ'
  ];

  @override
  void initState() {
    super.initState();

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    _amount = (widget.expenseData['amount'] as num).toDouble();
    _category = widget.expenseData['category']?.toString() ?? 'Ø£Ø®Ø±Ù‰';
    _description = widget.expenseData['description']?.toString() ?? '';
    _date = DateTime.parse(
        widget.expenseData['date']?.toString() ?? DateTime.now().toString());
    _isIncome = widget.expenseData['isIncome'] == true;
    _paymentMethod = widget.expenseData['paymentMethod']?.toString() ?? 'Ù†Ù‚Ø¯ÙŠ';

    _amountController.text = _amount.toString();
    _descriptionController.text = _description;
  }

  @override
  void dispose() {
    _amountController.dispose();
    _descriptionController.dispose();
    super.dispose();
  }

  String _formatDate(DateTime date) {
    try {
      return DateFormat('yyyy/MM/dd', 'ar').format(date);
    } catch (_) {
      return DateFormat('yyyy/MM/dd').format(date);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Directionality(
      textDirection: ui.TextDirection.rtl,
      child: Scaffold(
        appBar: AppBar(
          title: Text(_isIncome ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø®Ù„' : 'ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ'),
          centerTitle: true,
          actions: [
            IconButton(
              icon: const Icon(Icons.save),
              onPressed: _saveExpense,
              tooltip: 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª',
            ),
          ],
        ),
        body: Form(
          key: _formKey,
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(20),
            child: Column(
              children: [
                SwitchListTile(
                  title: Text(_isIncome ? 'Ø¯Ø®Ù„' : 'Ù…ØµØ±ÙˆÙ'),
                  value: _isIncome,
                  onChanged: (v) => setState(() => _isIncome = v),
                ),
                const SizedBox(height: 16),
                TextFormField(
                  controller: _amountController,
                  keyboardType: TextInputType.number,
                  decoration: const InputDecoration(labelText: 'Ø§Ù„Ù…Ø¨Ù„Øº'),
                  validator: (v) => v == null || double.tryParse(v) == null
                      ? 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§'
                      : null,
                  onSaved: (v) => _amount = double.parse(v!),
                ),
                const SizedBox(height: 16),
                DropdownButtonFormField(
                  value: _category,
                  decoration: const InputDecoration(labelText: 'Ø§Ù„ÙØ¦Ø©'),
                  items: _categories
                      .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                      .toList(),
                  onChanged: (v) => setState(() => _category = v!),
                ),
                const SizedBox(height: 16),
                ListTile(
                  title: const Text('Ø§Ù„ØªØ§Ø±ÙŠØ®'),
                  subtitle: Text(_formatDate(_date)),
                  trailing: const Icon(Icons.calendar_today),
                  onTap: () async {
                    final picked = await showDatePicker(
                      context: context,
                      initialDate: _date,
                      firstDate: DateTime(2000),
                      lastDate: DateTime(2100),
                      locale: const Locale('ar'),
                    );
                    if (picked != null) {
                      setState(() => _date = picked);
                    }
                  },
                ),
                const SizedBox(height: 16),
                DropdownButtonFormField(
                  value: _paymentMethod,
                  decoration: const InputDecoration(labelText: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'),
                  items: _paymentMethods
                      .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                      .toList(),
                  onChanged: (v) => setState(() => _paymentMethod = v!),
                ),
                const SizedBox(height: 16),
                TextFormField(
                  controller: _descriptionController,
                  maxLines: 3,
                  decoration:
                      const InputDecoration(labelText: 'Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'),
                  onSaved: (v) => _description = v ?? '',
                ),
                const SizedBox(height: 24),
                Row(
                  children: [
                    Expanded(
                      child: ElevatedButton(
                        onPressed: _saveExpense,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.blue,
                          foregroundColor: Colors.white,
                        ),
                        child: const Text('Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª'),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: OutlinedButton(
                        onPressed: () => Get.back(),
                        child: const Text('Ø¥Ù„ØºØ§Ø¡'),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
                ElevatedButton(
                  onPressed: _deleteExpense,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.red,
                    foregroundColor: Colors.white,
                  ),
                  child: const Text('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©'),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  void _saveExpense() {
    if (!_formKey.currentState!.validate()) return;
    _formKey.currentState!.save();

    final expense = ExpenseEntity(
      id: widget.expenseData['id']?.toString(), // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù€ ID
      amount: _amount,
      category: ExpenseCategory.fromString(_category),
      description: _description,
      date: _date,
      isIncome: _isIncome,
      paymentMethod: PaymentMethod.fromString(_paymentMethod),
    );

    _controller.updateExpense(widget.expenseIndex, expense);
    Get.back();
  }

  void _deleteExpense() {
    Get.defaultDialog(
      title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
      middleText: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ',
      textConfirm: 'Ø­Ø°Ù',
      textCancel: 'Ø¥Ù„ØºØ§Ø¡',
      confirmTextColor: Colors.white,
      onConfirm: () {
        _controller.deleteExpense(widget.expenseIndex);
        Get.back(); // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
        Get.back(); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      },
    );
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\presentation\pages\home_page.dart ===== 
import 'dart:ui' as ui;
import 'package:finance_app/core/models/enums.dart';
import 'package:finance_app/features/alerts/presentation/pages/alerts_settings_page.dart';
import 'package:finance_app/features/backup/presentation/pages/backup_page.dart';
import 'package:finance_app/features/expense/domain/entities/expense_entity.dart';
import 'package:finance_app/features/expense/presentation/pages/budget_page.dart';
import 'package:finance_app/features/expense/presentation/pages/edit_expense_page.dart';
import 'package:finance_app/features/expense/presentation/pages/reports_page.dart';
import 'package:finance_app/features/search/presentation/controllers/expense_search_controller.dart';
import 'package:finance_app/features/search/presentation/pages/filter_page.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:intl/intl.dart';

import '../controllers/expense_controller.dart';
import 'add_expense_page.dart';

class HomePage extends StatelessWidget {
  HomePage({super.key});

  final ExpenseController controller = Get.find();
  final ExpenseSearchController searchController =
      Get.find<ExpenseSearchController>(tag: ExpenseSearchController.TAG);

  @override
  Widget build(BuildContext context) {
    return Directionality(
      textDirection: ui.TextDirection.rtl,
      child: Scaffold(
        appBar: AppBar(
          title: const Text('Ù…Ø§Ù„ÙŠ - Finance App'),
          centerTitle: true,
          actions: [
            IconButton(
              icon: const Icon(Icons.delete_outline),
              onPressed: () {
                Get.defaultDialog(
                  title: 'Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                  middleText: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§ØªØŸ',
                  textConfirm: 'Ù†Ø¹Ù…',
                  textCancel: 'Ù„Ø§',
                  confirmTextColor: Colors.white,
                  onConfirm: () {
                    controller.clearAllData();
                    searchController.resetFilters();
                    Get.back();
                  },
                );
              },
              tooltip: 'Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
            ),
            IconButton(
              icon: const Icon(Icons.bar_chart),
              onPressed: () {
                Get.to(() => ReportsPage());
              },
              tooltip: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±',
            ),
            IconButton(
              icon: const Icon(Icons.account_balance_wallet),
              onPressed: () {
                Get.to(() => BudgetPage());
              },
              tooltip: 'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
            ),
            IconButton(
              icon: const Icon(Icons.notification_add),
              onPressed: () {
                Get.to(() => AlertsSettingsPage());
              },
              tooltip: 'Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª',
            ),
            IconButton(
              icon: const Icon(Icons.backup),
              onPressed: () {
                Get.to(() => BackupPage());
              },
              tooltip: 'Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ',
            ),
            IconButton(
              icon: Icon(
                Get.isDarkMode ? Icons.light_mode : Icons.dark_mode,
                color: Get.isDarkMode ? Colors.yellow[300] : Colors.grey[700],
              ),
              onPressed: () {
                Get.changeThemeMode(
                    Get.isDarkMode ? ThemeMode.light : ThemeMode.dark);
              },
              tooltip: Get.isDarkMode ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†',
            ),
          ],
        ),
        body: Obx(() {
          if (controller.isLoading.value) {
            return const Center(child: CircularProgressIndicator());
          }

          return Column(
            children: [
              // Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«
              _buildSearchBar(),

              Expanded(
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ø®Øµ
                      Card(
                        elevation: 4,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                        child: Padding(
                          padding: const EdgeInsets.all(20.0),
                          child: Column(
                            children: [
                              const Text(
                                'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ',
                                style: TextStyle(
                                  fontSize: 14,
                                  color: Colors.grey,
                                ),
                              ),
                              const SizedBox(height: 8),
                              Text(
                                '${controller.balance.value.toStringAsFixed(2)} Ø¬.Ù…',
                                style: TextStyle(
                                  fontSize: 36,
                                  fontWeight: FontWeight.bold,
                                  color: controller.balance.value >= 0
                                      ? Colors.green
                                      : Colors.red,
                                ),
                              ),
                              const SizedBox(height: 16),
                              Row(
                                mainAxisAlignment:
                                    MainAxisAlignment.spaceAround,
                                children: [
                                  Column(
                                    children: [
                                      const Icon(Icons.arrow_downward,
                                          color: Colors.green),
                                      const SizedBox(height: 4),
                                      const Text(
                                        'Ø§Ù„Ø¯Ø®Ù„',
                                        style: TextStyle(color: Colors.grey),
                                      ),
                                      const SizedBox(height: 4),
                                      Text(
                                        controller.totalIncome.value
                                            .toStringAsFixed(2),
                                        style: const TextStyle(
                                          fontWeight: FontWeight.bold,
                                          color: Colors.green,
                                        ),
                                      ),
                                    ],
                                  ),
                                  Column(
                                    children: [
                                      const Icon(Icons.arrow_upward,
                                          color: Colors.red),
                                      const SizedBox(height: 4),
                                      const Text(
                                        'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                                        style: TextStyle(color: Colors.grey),
                                      ),
                                      const SizedBox(height: 4),
                                      Text(
                                        controller.totalExpense.value
                                            .toStringAsFixed(2),
                                        style: const TextStyle(
                                          fontWeight: FontWeight.bold,
                                          color: Colors.red,
                                        ),
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                            ],
                          ),
                        ),
                      ),

                      const SizedBox(height: 24),

                      // Ø¹Ù†ÙˆØ§Ù† Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø¹ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Obx(() {
                            final filteredExpenses =
                                searchController.filteredExpenses;
                            final totalExpenses = controller.expenses.length;

                            if (searchController.searchQuery.value.isNotEmpty ||
                                searchController.selectedCategory.value !=
                                    'Ø§Ù„ÙƒÙ„' ||
                                searchController.selectedType.value != 'Ø§Ù„ÙƒÙ„') {
                              return Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text(
                                    'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«',
                                    style: TextStyle(
                                      fontSize: 18,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                  Text(
                                    '${filteredExpenses.length} Ù…Ù† ${totalExpenses} Ù…Ø¹Ø§Ù…Ù„Ø©',
                                    style: const TextStyle(
                                      fontSize: 12,
                                      color: Colors.grey,
                                    ),
                                  ),
                                ],
                              );
                            }

                            return const Text(
                              'Ø¢Ø®Ø± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
                              style: TextStyle(
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            );
                          }),
                          Row(
                            children: [
                              if (searchController
                                      .searchQuery.value.isNotEmpty ||
                                  searchController.selectedCategory.value !=
                                      'Ø§Ù„ÙƒÙ„' ||
                                  searchController.selectedType.value != 'Ø§Ù„ÙƒÙ„')
                                IconButton(
                                  icon: const Icon(Icons.clear, size: 20),
                                  onPressed: () {
                                    searchController.resetFilters();
                                  },
                                  tooltip: 'Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±',
                                ),
                              TextButton(
                                onPressed: () {
                                  Get.to(() => FilterPage());
                                },
                                child: const Text('ØªØµÙÙŠØ©'),
                              ),
                            ],
                          ),
                        ],
                      ),

                      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø«)
                      Expanded(
                        child: Obx(() {
                          final filteredExpenses =
                              searchController.filteredExpenses;

                          if (filteredExpenses.isEmpty) {
                            if (controller.expenses.isEmpty) {
                              return _buildEmptyState();
                            } else if (searchController
                                    .searchQuery.value.isNotEmpty ||
                                searchController.selectedCategory.value !=
                                    'Ø§Ù„ÙƒÙ„' ||
                                searchController.selectedType.value != 'Ø§Ù„ÙƒÙ„') {
                              return _buildNoResultsState();
                            }
                            return _buildEmptyState();
                          }

                          return ListView.builder(
                            itemCount: filteredExpenses.length,
                            itemBuilder: (context, index) {
                              final expense = filteredExpenses[index];

                              // âœ… Ø§Ù„Ø­Ù„: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… id
                              final originalIndex = controller.expenses
                                  .indexWhere((e) => e.id == expense['id']);

                              return _buildExpenseItem(expense, originalIndex);
                            },
                          );
                        }),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          );
        }),

        // Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯
        floatingActionButton: FloatingActionButton.extended(
          onPressed: () {
            Get.to(() => const AddExpensePage());
          },
          icon: const Icon(Icons.add),
          label: const Text('Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯'),
          backgroundColor: Colors.blue,
          foregroundColor: Colors.white,
          elevation: 4,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
        ),
      ),
    );
  }

  Widget _buildSearchBar() {
    return Container(
      padding: const EdgeInsets.all(12),
      color: Get.isDarkMode ? Colors.grey[900] : Colors.grey[50],
      child: Row(
        children: [
          Expanded(
            child: TextField(
              controller: TextEditingController(
                text: searchController.searchQuery.value,
              ),
              decoration: InputDecoration(
                hintText: 'Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª...',
                prefixIcon: const Icon(Icons.search),
                suffixIcon: searchController.searchQuery.value.isNotEmpty
                    ? IconButton(
                        icon: const Icon(Icons.clear, size: 20),
                        onPressed: () {
                          searchController.searchQuery.value = '';
                        },
                      )
                    : null,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                filled: true,
                fillColor: Get.isDarkMode ? Colors.grey[800] : Colors.white,
                contentPadding: const EdgeInsets.symmetric(
                  horizontal: 16,
                  vertical: 12,
                ),
                // âœ… Add theme-aware hint color
                hintStyle: TextStyle(
                  color: Get.isDarkMode ? Colors.grey[400] : Colors.grey[600],
                ),
              ),
              style: TextStyle(
                color: Get.isDarkMode ? Colors.white : Colors.black,
              ),
              onChanged: (value) {
                searchController.searchQuery.value = value;
              },
            ),
          ),
          const SizedBox(width: 8),
          IconButton(
            icon: const Icon(Icons.filter_list),
            onPressed: () {
              Get.to(() => FilterPage());
            },
            tooltip: 'ÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©',
            style: IconButton.styleFrom(
              backgroundColor: Colors.blue,
              foregroundColor: Colors.white,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.receipt_long,
            size: 64,
            color: Colors.grey[400],
          ),
          const SizedBox(height: 16),
          const Text(
            'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†',
            style: TextStyle(
              fontSize: 16,
              color: Colors.grey,
            ),
          ),
          const SizedBox(height: 8),
          const Text(
            'Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ø¹Ø§Ù…Ù„Ø© Ù„Ùƒ',
            style: TextStyle(
              fontSize: 14,
              color: Colors.grey,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildNoResultsState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.search_off,
            size: 64,
            color: Colors.grey[400],
          ),
          const SizedBox(height: 16),
          const Text(
            'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«',
            style: TextStyle(
              fontSize: 16,
              color: Colors.grey,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            searchController.searchQuery.value.isNotEmpty
                ? 'Ø¨Ø­Ø«: "${searchController.searchQuery.value}"'
                : 'Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©',
            style: const TextStyle(
              fontSize: 14,
              color: Colors.grey,
            ),
          ),
          const SizedBox(height: 16),
          ElevatedButton(
            onPressed: () {
              searchController.resetFilters();
            },
            child: const Text('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ÙÙ„Ø§ØªØ±'),
          ),
        ],
      ),
    );
  }

  // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© _buildExpenseItem Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:

  Widget _buildExpenseItem(dynamic expense, int index) {
    return Card(
      margin: const EdgeInsets.only(bottom: 8),
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      child: Directionality(
        textDirection: ui.TextDirection.rtl,
        child: ListTile(
          leading: CircleAvatar(
            backgroundColor: expense['isIncome']
                ? Colors.green.withOpacity(0.1)
                : Colors.red.withOpacity(0.1),
            child: Icon(
              expense['isIncome'] ? Icons.download : Icons.upload,
              color: expense['isIncome'] ? Colors.green : Colors.red,
            ),
          ),
          title: Text(
            expense['category'],
            style: const TextStyle(
              fontWeight: FontWeight.w600,
              fontSize: 16,
            ),
          ),
          subtitle: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              if (expense['description'].toString().isNotEmpty)
                Text(
                  expense['description'].toString(),
                  style: const TextStyle(fontSize: 13),
                ),
              const SizedBox(height: 2),
              Text(
                _formatDate(expense['date']),
                style: TextStyle(
                  fontSize: 12,
                  color: Colors.grey[600],
                ),
              ),
            ],
          ),
          trailing: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Ø§Ù„Ù…Ø¨Ù„Øº
              Text(
                '${expense['amount']} Ø¬.Ù…',
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: expense['isIncome'] ? Colors.green : Colors.red,
                  fontSize: 14,
                ),
              ),
              const SizedBox(width: 8),
              // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚
              PopupMenuButton<String>(
                icon: const Icon(Icons.more_vert, size: 20),
                itemBuilder: (context) => [
                  const PopupMenuItem(
                    value: 'edit',
                    child: Row(
                      children: [
                        Icon(Icons.edit, size: 18, color: Colors.blue),
                        SizedBox(width: 8),
                        Text('ØªØ¹Ø¯ÙŠÙ„'),
                      ],
                    ),
                  ),
                  const PopupMenuItem(
                    value: 'delete',
                    child: Row(
                      children: [
                        Icon(Icons.delete, size: 18, color: Colors.red),
                        SizedBox(width: 8),
                        Text('Ø­Ø°Ù'),
                      ],
                    ),
                  ),
                  const PopupMenuItem(
                    value: 'duplicate',
                    child: Row(
                      children: [
                        Icon(Icons.content_copy,
                            size: 18, color: Colors.purple),
                        SizedBox(width: 8),
                        Text('Ù†Ø³Ø®'),
                      ],
                    ),
                  ),
                ],
                onSelected: (value) {
                  _handleExpenseAction(value, index, expense);
                },
              ),
            ],
          ),
          onTap: () {
            _showExpenseDetails(expense, index);
          },
        ),
      ),
    );
  }

  String _formatDate(String dateString) {
    try {
      final date = DateTime.parse(dateString);
      return DateFormat('yyyy/MM/dd', 'ar').format(date);
    } catch (e) {
      return dateString;
    }
  }

  void _showExpenseDetails(dynamic expense, int index) {
    Get.bottomSheet(
      Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: Get.isDarkMode ? Colors.grey[900] : Colors.white,
          borderRadius: const BorderRadius.only(
            topLeft: Radius.circular(20),
            topRight: Radius.circular(20),
          ),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Center(
              child: Container(
                width: 40,
                height: 5,
                decoration: BoxDecoration(
                  color: Colors.grey[300],
                  borderRadius: BorderRadius.circular(3),
                ),
              ),
            ),
            const SizedBox(height: 20),
            Text(
              'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: Colors.blue[800],
              ),
            ),
            const SizedBox(height: 16),
            _buildDetailRow('Ø§Ù„Ù…Ø¨Ù„Øº:', '${expense['amount']} Ø¬.Ù…'),
            _buildDetailRow('Ø§Ù„Ù†ÙˆØ¹:', expense['isIncome'] ? 'Ø¯Ø®Ù„' : 'Ù…ØµØ±ÙˆÙ'),
            _buildDetailRow('Ø§Ù„ÙØ¦Ø©:', expense['category']),
            if (expense['description'].toString().isNotEmpty)
              _buildDetailRow('Ø§Ù„ÙˆØµÙ:', expense['description'].toString()),
            _buildDetailRow('Ø§Ù„ØªØ§Ø±ÙŠØ®:', _formatDate(expense['date'])),
            _buildDetailRow('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:', expense['paymentMethod'] ?? 'Ù†Ù‚Ø¯ÙŠ'),
            const SizedBox(height: 20),
            Row(
              children: [
                Expanded(
                  child: OutlinedButton(
                    onPressed: () => Get.back(),
                    child: const Text('Ø¥ØºÙ„Ø§Ù‚'),
                  ),
                ),
                const SizedBox(width: 10),
                Expanded(
                  child: ElevatedButton(
                    onPressed: () {
                      Get.back();
                      Get.defaultDialog(
                        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
                        middleText: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ',
                        textConfirm: 'Ø­Ø°Ù',
                        textCancel: 'Ø¥Ù„ØºØ§Ø¡',
                        confirmTextColor: Colors.white,
                        onConfirm: () {
                          // âœ… ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† index ØµØ§Ù„Ø­
                          if (index >= 0 &&
                              index < controller.expenses.length) {
                            controller.deleteExpense(index);
                            searchController.resetFilters();
                            Get.back();
                          } else {
                            Get.snackbar(
                              'Ø®Ø·Ø£',
                              'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©',
                              snackPosition: SnackPosition.BOTTOM,
                            );
                          }
                        },
                      );
                    },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.red,
                    ),
                    child: const Text('Ø­Ø°Ù'),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

// Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ø¯Ø§Ù„Ø© _showExpenseDetails Ù…Ø¨Ø§Ø´Ø±Ø©

  void _handleExpenseAction(String action, int index, dynamic expense) {
    switch (action) {
      case 'edit':
        _editExpense(index, expense);
        break;
      case 'delete':
        _deleteExpense(index);
        break;
      case 'duplicate':
        _duplicateExpense(expense);
        break;
    }
  }

  void _editExpense(int index, dynamic expense) {
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    Get.to(() => EditExpensePage(
          expenseIndex: index,
          expenseData: expense,
        ));
  }

  void _deleteExpense(int index) {
    Get.defaultDialog(
      title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
      middleText: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ',
      textConfirm: 'Ø­Ø°Ù',
      textCancel: 'Ø¥Ù„ØºØ§Ø¡',
      confirmTextColor: Colors.white,
      onConfirm: () {
        if (index >= 0 && index < controller.expenses.length) {
          controller.deleteExpense(index);
          searchController.resetFilters();
          Get.back();
          Get.snackbar(
            'ØªÙ… Ø§Ù„Ø­Ø°Ù',
            'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­',
            snackPosition: SnackPosition.BOTTOM,
            backgroundColor: Colors.green[100],
            colorText: Colors.green[900],
          );
        }
      },
    );
  }

  void _duplicateExpense(dynamic expense) {
    try {
      final newExpense = ExpenseEntity(
        amount: (expense['amount'] as num).toDouble(),
        category: ExpenseCategory.fromString(expense['category']),
        description: expense['description']?.toString() ?? '',
        date: DateTime.now(), // ØªØ§Ø±ÙŠØ® Ø¬Ø¯ÙŠØ¯
        isIncome: expense['isIncome'] == true,
        paymentMethod: PaymentMethod.fromString(
            expense['paymentMethod']?.toString() ?? 'Ù†Ù‚Ø¯ÙŠ'),
      );

      controller.addExpense(newExpense);

      Get.snackbar(
        'ØªÙ… Ø§Ù„Ù†Ø³Ø®',
        'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­',
        snackPosition: SnackPosition.BOTTOM,
        backgroundColor: Colors.blue[100],
        colorText: Colors.blue[900],
      );
    } catch (e) {
      Get.snackbar(
        'Ø®Ø·Ø£',
        'ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©',
        snackPosition: SnackPosition.BOTTOM,
      );
    }
  }

  Widget _buildDetailRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 100,
            child: Text(
              label,
              style: const TextStyle(
                fontWeight: FontWeight.bold,
                color: Colors.grey,
              ),
            ),
          ),
          const SizedBox(width: 10),
          Expanded(
            child: Text(
              value,
              style: TextStyle(
                color: Get.isDarkMode ? Colors.white : Colors.black87,
              ),
            ),
          ),
        ],
      ),
    );
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\presentation\pages\monthly_analysis_page.dart ===== 
// lib/features/expense/presentation/pages/monthly_analysis_page.dart

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:fl_chart/fl_chart.dart';
import '../controllers/expense_controller.dart';

class MonthlyAnalysisPage extends StatelessWidget {
  MonthlyAnalysisPage({super.key});
  final ExpenseController controller = Get.find();

  @override
  Widget build(BuildContext context) {
    final monthlyData = _getMonthlyData();

    return Scaffold(
      appBar: AppBar(
        title: const Text('ØªØ­Ù„ÙŠÙ„ Ø´Ù‡Ø±ÙŠ - Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø´Ù‡Ø±'),
        centerTitle: true,
      ),
      body: monthlyData.isEmpty
          ? _buildEmptyState()
          : SingleChildScrollView(
              padding: const EdgeInsets.all(16),
              child: Column(
                children: [
                  // 1. Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
                  Card(
                    elevation: 4,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16),
                      child: Column(
                        children: [
                          const Text(
                            'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø®Ù„Ø§Ù„ 6 Ø£Ø´Ù‡Ø±',
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const SizedBox(height: 16),
                          SizedBox(
                            height: 300,
                            child: _buildMonthlyChart(monthlyData),
                          ),
                          const SizedBox(height: 16),
                          _buildChartLegend(),
                        ],
                      ),
                    ),
                  ),

                  const SizedBox(height: 24),

                  // 2. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                  Card(
                    elevation: 4,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Ù…Ù‚Ø§Ø±Ù†Ø© Ù…ÙØµÙ„Ø© Ù„ÙƒÙ„ Ø´Ù‡Ø±',
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const SizedBox(height: 16),
                          _buildComparisonTable(monthlyData),
                        ],
                      ),
                    ),
                  ),

                  const SizedBox(height: 24),

                  // 3. Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                  _buildAdditionalStats(monthlyData),
                ],
              ),
            ),
    );
  }

  // ============ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ============

  List<Map<String, dynamic>> _getMonthlyData() {
    final List<Map<String, dynamic>> data = [];
    final now = DateTime.now();

    for (int i = 5; i >= 0; i--) {
      final month = DateTime(now.year, now.month - i, 1);
      final monthName = _getMonthName(month.month);

      final monthlyExpenses = controller.expenses.where((expense) {
        return expense.date.month == month.month &&
            expense.date.year == month.year;
      }).toList();

      double income = 0;
      double expense = 0;

      for (var exp in monthlyExpenses) {
        if (exp.isIncome) {
          income += exp.amount;
        } else {
          expense += exp.amount;
        }
      }

      data.add({
        'month': monthName,
        'monthShort': _getMonthShortName(month.month),
        'year': month.year,
        'income': income,
        'expense': expense,
        'balance': income - expense,
        'transactionCount': monthlyExpenses.length,
      });
    }

    return data;
  }

  Widget _buildMonthlyChart(List<Map<String, dynamic>> data) {
    return BarChart(
      BarChartData(
        alignment: BarChartAlignment.spaceAround,
        maxY: _getMaxAmount(data) * 1.2,
        minY: 0,
        barTouchData: BarTouchData(
          enabled: true,
          touchTooltipData: BarTouchTooltipData(
            tooltipBgColor: Colors.white,
            tooltipPadding: const EdgeInsets.all(8),
            getTooltipItem: (group, groupIndex, rod, rodIndex) {
              final month = data[groupIndex]['monthShort'];
              final value = rod.toY.toStringAsFixed(2);
              final type = rodIndex == 0 ? 'Ø§Ù„Ø¯Ø®Ù„' : 'Ø§Ù„Ù…ØµØ±ÙˆÙ';
              return BarTooltipItem(
                '$month\n$type: $value Ø¬.Ù…',
                const TextStyle(
                  color: Colors.black,
                  fontWeight: FontWeight.bold,
                ),
              );
            },
          ),
        ),
        titlesData: FlTitlesData(
          show: true,
          bottomTitles: AxisTitles(
            sideTitles: SideTitles(
              showTitles: true,
              getTitlesWidget: (value, meta) {
                final index = value.toInt();
                if (index >= 0 && index < data.length) {
                  return Padding(
                    padding: const EdgeInsets.only(top: 8),
                    child: Text(
                      data[index]['monthShort'],
                      style: const TextStyle(
                        fontSize: 12,
                        color: Colors.grey,
                      ),
                    ),
                  );
                }
                return const Text('');
              },
              reservedSize: 32,
            ),
          ),
          leftTitles: AxisTitles(
            sideTitles: SideTitles(
              showTitles: true,
              interval: _getChartInterval(data),
              getTitlesWidget: (value, meta) {
                return Text(
                  '${value.toInt()}',
                  style: const TextStyle(
                    fontSize: 10,
                    color: Colors.grey,
                  ),
                );
              },
              reservedSize: 40,
            ),
          ),
          topTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
          rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
        ),
        gridData: FlGridData(
          show: true,
          drawVerticalLine: false,
          horizontalInterval: _getChartInterval(data),
        ),
        borderData: FlBorderData(
          show: true,
          border: const Border(
            bottom: BorderSide(color: Colors.grey, width: 1),
            left: BorderSide(color: Colors.grey, width: 1),
          ),
        ),
        barGroups: List.generate(data.length, (index) {
          return BarChartGroupData(
            x: index,
            groupVertically: true,
            barRods: [
              BarChartRodData(
                toY: data[index]['income'],
                color: Colors.green,
                width: 16,
                borderRadius: BorderRadius.circular(4),
              ),
              BarChartRodData(
                toY: data[index]['expense'],
                color: Colors.red,
                width: 16,
                borderRadius: BorderRadius.circular(4),
              ),
            ],
          );
        }),
      ),
    );
  }

  Widget _buildChartLegend() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        _buildLegendItem('Ø§Ù„Ø¯Ø®Ù„', Colors.green),
        const SizedBox(width: 24),
        _buildLegendItem('Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', Colors.red),
      ],
    );
  }

  Widget _buildLegendItem(String text, Color color) {
    return Row(
      children: [
        Container(
          width: 16,
          height: 16,
          decoration: BoxDecoration(
            color: color,
            borderRadius: BorderRadius.circular(4),
          ),
        ),
        const SizedBox(width: 8),
        Text(
          text,
          style: const TextStyle(fontSize: 14),
        ),
      ],
    );
  }

  Widget _buildComparisonTable(List<Map<String, dynamic>> data) {
    return SingleChildScrollView(
      scrollDirection: Axis.horizontal,
      child: DataTable(
        columnSpacing: 24,
        dataRowMinHeight: 40,
        columns: const [
          DataColumn(label: Text('Ø§Ù„Ø´Ù‡Ø±')),
          DataColumn(label: Text('Ø§Ù„Ø¯Ø®Ù„', textAlign: TextAlign.center)),
          DataColumn(label: Text('Ø§Ù„Ù…ØµØ±ÙˆÙ', textAlign: TextAlign.center)),
          DataColumn(label: Text('Ø§Ù„Ø±ØµÙŠØ¯', textAlign: TextAlign.center)),
          DataColumn(label: Text('Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', textAlign: TextAlign.center)),
        ],
        rows: data.map((monthData) {
          return DataRow(cells: [
            DataCell(Text('${monthData['month']}')),
            DataCell(Text(
              '${monthData['income'].toStringAsFixed(2)}',
              style: TextStyle(color: Colors.green[700]),
              textAlign: TextAlign.center,
            )),
            DataCell(Text(
              '${monthData['expense'].toStringAsFixed(2)}',
              style: TextStyle(color: Colors.red[700]),
              textAlign: TextAlign.center,
            )),
            DataCell(Text(
              '${monthData['balance'].toStringAsFixed(2)}',
              style: TextStyle(
                color: monthData['balance'] >= 0 ? Colors.green : Colors.red,
                fontWeight: FontWeight.bold,
              ),
              textAlign: TextAlign.center,
            )),
            DataCell(Text(
              monthData['transactionCount'].toString(),
              textAlign: TextAlign.center,
            )),
          ]);
        }).toList(),
      ),
    );
  }

  Widget _buildAdditionalStats(List<Map<String, dynamic>> data) {
    // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‡Ù†Ø§:
    final totalTransactions =
        data.fold(0, (sum, month) => sum + (month['transactionCount'] as int));

    final totalBalance =
        data.fold(0.0, (sum, month) => sum + (month['balance'] as double));

    return Row(
      children: [
        Expanded(
          child: Card(
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                children: [
                  const Icon(Icons.receipt_long, color: Colors.blue, size: 32),
                  const SizedBox(height: 8),
                  Text(
                    totalTransactions.toString(),
                    style: const TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: Colors.blue,
                    ),
                  ),
                  const Text('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
                      style: TextStyle(fontSize: 12)),
                ],
              ),
            ),
          ),
        ),
        const SizedBox(width: 16),
        Expanded(
          child: Card(
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                children: [
                  Icon(
                    totalBalance >= 0 ? Icons.trending_up : Icons.trending_down,
                    color: totalBalance >= 0 ? Colors.green : Colors.red,
                    size: 32,
                  ),
                  const SizedBox(height: 8),
                  Text(
                    totalBalance.toStringAsFixed(2),
                    style: TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: totalBalance >= 0 ? Colors.green : Colors.red,
                    ),
                  ),
                  const Text('ØµØ§ÙÙŠ Ø§Ù„ÙØªØ±Ø©', style: TextStyle(fontSize: 12)),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.bar_chart,
            size: 64,
            color: Colors.grey[400],
          ),
          const SizedBox(height: 16),
          const Text(
            'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„',
            style: TextStyle(
              fontSize: 16,
              color: Colors.grey,
            ),
          ),
          const SizedBox(height: 8),
          const Text(
            'Ø£Ø¶Ù Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„ØªØ±Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
            style: TextStyle(
              fontSize: 14,
              color: Colors.grey,
            ),
          ),
        ],
      ),
    );
  }

  double _getMaxAmount(List<Map<String, dynamic>> data) {
    double max = 0;
    for (var item in data) {
      if ((item['income'] as double) > max) max = item['income'] as double;
      if ((item['expense'] as double) > max) max = item['expense'] as double;
    }
    return max == 0 ? 1000 : max;
  }

  double _getChartInterval(List<Map<String, dynamic>> data) {
    final maxAmount = _getMaxAmount(data);
    if (maxAmount < 1000) return 200;
    if (maxAmount < 5000) return 1000;
    if (maxAmount < 20000) return 5000;
    return 10000;
  }

  String _getMonthName(int month) {
    final months = [
      'ÙŠÙ†Ø§ÙŠØ±',
      'ÙØ¨Ø±Ø§ÙŠØ±',
      'Ù…Ø§Ø±Ø³',
      'Ø£Ø¨Ø±ÙŠÙ„',
      'Ù…Ø§ÙŠÙˆ',
      'ÙŠÙˆÙ†ÙŠÙˆ',
      'ÙŠÙˆÙ„ÙŠÙˆ',
      'Ø£ØºØ³Ø·Ø³',
      'Ø³Ø¨ØªÙ…Ø¨Ø±',
      'Ø£ÙƒØªÙˆØ¨Ø±',
      'Ù†ÙˆÙÙ…Ø¨Ø±',
      'Ø¯ÙŠØ³Ù…Ø¨Ø±'
    ];
    return months[month - 1];
  }

  String _getMonthShortName(int month) {
    final months = [
      'ÙŠÙ†Ø§',
      'ÙØ¨Ø±',
      'Ù…Ø§Ø±',
      'Ø£Ø¨Ø±',
      'Ù…Ø§ÙŠ',
      'ÙŠÙˆÙ†',
      'ÙŠÙˆÙ„',
      'Ø£ØºØ³',
      'Ø³Ø¨Øª',
      'Ø£ÙƒØª',
      'Ù†ÙˆÙ',
      'Ø¯ÙŠØ³'
    ];
    return months[month - 1];
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\presentation\pages\reports_page.dart ===== 
// lib/features/expense/presentation/pages/reports_page.dart

import 'package:finance_app/features/expense/presentation/controllers/expense_controller.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:intl/intl.dart';
import '../controllers/expense_controller.dart';
import 'monthly_analysis_page.dart';
import 'package:finance_app/features/export/presentation/export_service.dart';

class ReportsPage extends StatelessWidget {
  ReportsPage({super.key});
  final ExpenseController controller = Get.find();

  @override
  Widget build(BuildContext context) {
    final monthlyStats = controller.getMonthlyStats();
    final incomeCategories = controller.getExpensesByCategory(true);
    final expenseCategories = controller.getExpensesByCategory(false);

    return Scaffold(
      appBar: AppBar(
        title: const Text('Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª'),
        centerTitle: true,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Ø¨Ø·Ø§Ù‚Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±
            Card(
              elevation: 4,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  children: [
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(Icons.calendar_today, color: Colors.blue),
                        const SizedBox(width: 8),
                        Text(
                          'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${_getCurrentMonth()}',
                          style: const TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                            color: Colors.blue,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 20),

                    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceAround,
                      children: [
                        _buildStatItem(
                          'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
                          '${monthlyStats['count']}',
                          Icons.receipt,
                          Colors.blue,
                        ),
                        _buildStatItem(
                          'Ø§Ù„Ø¯Ø®Ù„',
                          '${(monthlyStats['income'] as double).toStringAsFixed(2)} Ø¬.Ù…',
                          Icons.arrow_downward,
                          Colors.green,
                        ),
                        _buildStatItem(
                          'Ø§Ù„Ù…ØµØ±ÙˆÙ',
                          '${(monthlyStats['expense'] as double).toStringAsFixed(2)} Ø¬.Ù…',
                          Icons.arrow_upward,
                          Colors.red,
                        ),
                      ],
                    ),

                    const SizedBox(height: 20),

                    // Ø±ØµÙŠØ¯ Ø§Ù„Ø´Ù‡Ø±
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: (monthlyStats['balance'] as double) >= 0
                            ? Colors.green.withOpacity(0.1)
                            : Colors.red.withOpacity(0.1),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            (monthlyStats['balance'] as double) >= 0
                                ? Icons.trending_up
                                : Icons.trending_down,
                            color: (monthlyStats['balance'] as double) >= 0
                                ? Colors.green
                                : Colors.red,
                          ),
                          const SizedBox(width: 10),
                          Text(
                            'Ø±ØµÙŠØ¯ Ø§Ù„Ø´Ù‡Ø±: ${(monthlyStats['balance'] as double).toStringAsFixed(2)} Ø¬.Ù…',
                            style: TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                              color: (monthlyStats['balance'] as double) >= 0
                                  ? Colors.green
                                  : Colors.red,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),

            const SizedBox(height: 24),

            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø®Ù„ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
            _buildCategorySection(
              'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø®Ù„',
              incomeCategories,
              Colors.green,
              Icons.arrow_downward,
            ),

            const SizedBox(height: 24),

            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
            _buildCategorySection(
              'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
              expenseCategories,
              Colors.red,
              Icons.arrow_upward,
            ),

            const SizedBox(height: 24),

            // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
            _buildAdditionalStats(),

            const SizedBox(height: 24),

            // Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©
            Card(
              elevation: 4,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16),
              ),
              child: Column(
                children: [
                  ListTile(
                    leading: const Icon(Icons.download, color: Colors.blue),
                    title: const Text('ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'),
                    subtitle: const Text('Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª'),
                    trailing: const Icon(Icons.chevron_right),
                    onTap: _exportData,
                  ),
                  const Divider(height: 0),
                  ListTile(
                    leading: const Icon(Icons.insights, color: Colors.purple),
                    title: const Text('ØªØ­Ù„ÙŠÙ„ Ø´Ù‡Ø±ÙŠ'),
                    subtitle: const Text('Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©'),
                    trailing: const Icon(Icons.chevron_right),
                    onTap: () {
                      Get.to(() => MonthlyAnalysisPage());
                    },
                  ),
                ],
              ),
            ),

            const SizedBox(height: 32),
          ],
        ),
      ),
    );
  }

  Widget _buildStatItem(
      String title, String value, IconData icon, Color color) {
    return Column(
      children: [
        Container(
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: color.withOpacity(0.1),
            shape: BoxShape.circle,
          ),
          child: Icon(icon, color: color, size: 24),
        ),
        const SizedBox(height: 8),
        Text(
          title,
          style: const TextStyle(
            fontSize: 12,
            color: Colors.grey,
          ),
        ),
        const SizedBox(height: 4),
        Text(
          value,
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.bold,
            color: color,
          ),
        ),
      ],
    );
  }

  Widget _buildCategorySection(
    String title,
    Map<String, double> categories,
    Color color,
    IconData icon,
  ) {
    final total = categories.values.fold(0.0, (sum, value) => sum + value);

    return Card(
      elevation: 4,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(icon, color: color),
                const SizedBox(width: 8),
                Text(
                  title,
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const Spacer(),
                Text(
                  '${total.toStringAsFixed(2)} Ø¬.Ù…',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: color,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),
            if (categories.isEmpty)
              const Center(
                child: Padding(
                  padding: EdgeInsets.all(16),
                  child: Text(
                    'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
                    style: TextStyle(color: Colors.grey),
                  ),
                ),
              )
            else
              ...categories.entries.map((entry) {
                final percentage = total > 0 ? (entry.value / total * 100) : 0;

                return Padding(
                  padding: const EdgeInsets.symmetric(vertical: 8),
                  child: Column(
                    children: [
                      Row(
                        children: [
                          Expanded(
                            child: Text(
                              entry.key,
                              style: const TextStyle(fontSize: 14),
                            ),
                          ),
                          Text(
                            '${entry.value.toStringAsFixed(2)} Ø¬.Ù…',
                            style: const TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 4),
                      Row(
                        children: [
                          Expanded(
                            flex: 8,
                            child: LinearProgressIndicator(
                              value: percentage / 100,
                              backgroundColor: color.withOpacity(0.2),
                              valueColor: AlwaysStoppedAnimation<Color>(color),
                              minHeight: 6,
                              borderRadius: BorderRadius.circular(3),
                            ),
                          ),
                          const SizedBox(width: 8),
                          Expanded(
                            flex: 2,
                            child: Text(
                              '${percentage.toStringAsFixed(1)}%',
                              style: TextStyle(
                                fontSize: 12,
                                color: Colors.grey[600],
                              ),
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                );
              }).toList(),
          ],
        ),
      ),
    );
  }

  Widget _buildAdditionalStats() {
    final recentExpenses = controller.recentExpenses;
    final totalExpenses = controller.expenseCount;

    return Card(
      elevation: 4,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©',
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 12),
            Row(
              children: [
                Expanded(
                  child: Column(
                    children: [
                      const Icon(Icons.receipt_long,
                          color: Colors.blue, size: 24),
                      const SizedBox(height: 8),
                      Text(
                        totalExpenses.toString(),
                        style: const TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      const Text(
                        'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
                        style: TextStyle(fontSize: 12, color: Colors.grey),
                      ),
                    ],
                  ),
                ),
                Expanded(
                  child: Column(
                    children: [
                      const Icon(Icons.access_time,
                          color: Colors.orange, size: 24),
                      const SizedBox(height: 8),
                      Text(
                        recentExpenses.length.toString(),
                        style: const TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      const Text(
                        'Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø¯ÙŠØ«Ø©',
                        style: TextStyle(fontSize: 12, color: Colors.grey),
                      ),
                    ],
                  ),
                ),
                Expanded(
                  child: Column(
                    children: [
                      Icon(
                        controller.balance.value >= 0
                            ? Icons.trending_up
                            : Icons.trending_down,
                        color: controller.balance.value >= 0
                            ? Colors.green
                            : Colors.red,
                        size: 24,
                      ),
                      const SizedBox(height: 8),
                      Text(
                        controller.balance.value.toStringAsFixed(2),
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: controller.balance.value >= 0
                              ? Colors.green
                              : Colors.red,
                        ),
                      ),
                      const Text(
                        'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ',
                        style: TextStyle(fontSize: 12, color: Colors.grey),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  String _getCurrentMonth() {
    final now = DateTime.now();
    final months = [
      'ÙŠÙ†Ø§ÙŠØ±',
      'ÙØ¨Ø±Ø§ÙŠØ±',
      'Ù…Ø§Ø±Ø³',
      'Ø£Ø¨Ø±ÙŠÙ„',
      'Ù…Ø§ÙŠÙˆ',
      'ÙŠÙˆÙ†ÙŠÙˆ',
      'ÙŠÙˆÙ„ÙŠÙˆ',
      'Ø£ØºØ³Ø·Ø³',
      'Ø³Ø¨ØªÙ…Ø¨Ø±',
      'Ø£ÙƒØªÙˆØ¨Ø±',
      'Ù†ÙˆÙÙ…Ø¨Ø±',
      'Ø¯ÙŠØ³Ù…Ø¨Ø±'
    ];
    return '${months[now.month - 1]} ${now.year}';
  }

  void _exportData() async {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
      if (controller.expenses.isEmpty) {
        Get.snackbar(
          'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
          'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§',
          snackPosition: SnackPosition.BOTTOM,
          backgroundColor: Colors.orange[100],
          colorText: Colors.orange[900],
        );
        return;
      }

      // Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±
      final result = await ExportService.exportData(controller.expensesAsMap);

      if (result == true) {
        Get.snackbar(
          'âœ… ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­',
          'ØªÙ… Ø­ÙØ¸ Ù…Ù„Ù Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­',
          snackPosition: SnackPosition.BOTTOM,
          duration: const Duration(seconds: 3),
          backgroundColor: Colors.green[100],
          colorText: Colors.green[900],
        );
      }
    } catch (e) {
      Get.snackbar(
        'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±',
        'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±: $e',
        snackPosition: SnackPosition.BOTTOM,
        backgroundColor: Colors.red[100],
        colorText: Colors.red[900],
      );
    }
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\expense\presentation\widgets\simple_card.dart ===== 
// lib/features/expense/presentation/widgets/simple_card.dart

import 'package:flutter/material.dart';

class SimpleCard extends StatelessWidget {
  final Widget child;
  final EdgeInsets padding;

  const SimpleCard({
    super.key,
    required this.child,
    this.padding = const EdgeInsets.all(16),
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      child: Padding(
        padding: padding,
        child: child,
      ),
    );
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\export\presentation\export_service.dart ===== 
// lib/features/export/presentation/export_service.dart

import 'dart:convert';
import 'dart:io';
import 'package:finance_app/features/expense/presentation/controllers/expense_controller.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:intl/intl.dart';
import 'package:path_provider/path_provider.dart';
import 'package:share_plus/share_plus.dart';
import 'package:csv/csv.dart';

class ExportService {
  // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØªÙŠ ØªØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ reports_page
  static Future<bool> exportData(List<Map<String, dynamic>> expenses) async {
    try {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
      if (expenses.isEmpty) {
        Get.snackbar(
          'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
          'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§',
          snackPosition: SnackPosition.BOTTOM,
          backgroundColor: Colors.orange[100],
          colorText: Colors.orange[900],
        );
        return false;
      }

      final exportFormat = await _showExportFormatDialog();
      if (exportFormat == null) return false;

      switch (exportFormat) {
        case 'csv':
          await _exportToCSV(expenses);
          break;
        case 'json':
          await _exportToJSON(expenses);
          break;
        default:
          return false;
      }

      return true;
    } catch (e) {
      print('âŒ Export error: $e');
      Get.snackbar(
        'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±',
        'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹',
        snackPosition: SnackPosition.BOTTOM,
        backgroundColor: Colors.red[100],
        colorText: Colors.red[900],
      );
      return false;
    }
  }

  // âœ… Ø¯Ø§Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø© ØªØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ reports_page Ù…Ø¨Ø§Ø´Ø±Ø© (Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
  static Future<bool> exportSummary() async {
    try {
      // Ø¬Ù„Ø¨ Ø§Ù„Ù…ØªØ­ÙƒÙ…
      final expenseController = Get.find<ExpenseController>();
      final expenses = expenseController.expensesAsMap;

      return await exportData(expenses);
    } catch (e) {
      print('âŒ Export summary error: $e');
      Get.snackbar(
        'âŒ Ø®Ø·Ø£',
        'ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
        snackPosition: SnackPosition.BOTTOM,
      );
      return false;
    }
  }

  // âœ… Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±
  static Future<String?> _showExportFormatDialog() async {
    return await Get.dialog<String>(
      AlertDialog(
        title: const Text('ğŸ“¤ Ø§Ø®ØªØ± ØµÙŠØºØ© Ø§Ù„ØªØµØ¯ÙŠØ±'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            ListTile(
              leading: const Icon(Icons.table_chart, color: Colors.blue),
              title: const Text('CSV (Excel)'),
              subtitle: const Text('Ù…Ù„Ù Ø¬Ø¯ÙˆÙ„ ÙŠÙ…ÙƒÙ† ÙØªØ­Ù‡ ÙÙŠ Excel'),
              onTap: () => Get.back(result: 'csv'),
            ),
            const Divider(height: 1),
            ListTile(
              leading: const Icon(Icons.code, color: Colors.green),
              title: const Text('JSON'),
              subtitle: const Text('Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©'),
              onTap: () => Get.back(result: 'json'),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Get.back(),
            child: const Text('Ø¥Ù„ØºØ§Ø¡'),
          ),
        ],
      ),
      barrierDismissible: true,
    );
  }

  // âœ… ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ CSV
  static Future<void> _exportToCSV(List<Map<String, dynamic>> expenses) async {
    try {
      final List<List<dynamic>> csvData = [];

      // Ø±Ø£Ø³ Ø§Ù„Ù…Ù„Ù
      csvData.add([
        'Ø§Ù„ØªØ§Ø±ÙŠØ®',
        'Ø§Ù„Ù†ÙˆØ¹',
        'Ø§Ù„ÙØ¦Ø©',
        'Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)',
        'Ø§Ù„ÙˆØµÙ',
        'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹',
      ]);

      // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      for (var expense in expenses) {
        final date = expense['date']?.toString() ?? '';
        final isIncome = expense['isIncome'] == true;
        final category = expense['category']?.toString() ?? 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        final amount = expense['amount']?.toString() ?? '0.00';
        final description = expense['description']?.toString() ?? '';
        final paymentMethod = expense['paymentMethod']?.toString() ?? 'Ù†Ù‚Ø¯ÙŠ';

        csvData.add([
          date,
          isIncome ? 'Ø¯Ø®Ù„' : 'Ù…ØµØ±ÙˆÙ',
          category,
          amount,
          description,
          paymentMethod,
        ]);
      }

      // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù†Øµ CSV
      final csvString = const ListToCsvConverter().convert(csvData);

      // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ù…Ø¤Ù‚ØªØ§Ù‹
      final directory = await getTemporaryDirectory();
      final timestamp = DateTime.now().millisecondsSinceEpoch;
      final fileName = 'Ù…Ø§Ù„ÙŠ_ØªØµØ¯ÙŠØ±_$timestamp.csv';
      final file = File('${directory.path}/$fileName');
      await file.writeAsString(csvString, flush: true);

      // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù
      await Share.shareXFiles(
        [XFile(file.path)],
        subject: 'ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ',
        text:
            'ØªÙ… ØªØµØ¯ÙŠØ± ${expenses.length} Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨ØªØ§Ø±ÙŠØ® ${_formatDate(DateTime.now())}',
      );

      print('âœ… CSV export successful: ${file.path}');
    } catch (e) {
      print('âŒ CSV export error: $e');
      rethrow;
    }
  }

  // âœ… ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ JSON
  static Future<void> _exportToJSON(List<Map<String, dynamic>> expenses) async {
    try {
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      double totalIncome = 0;
      double totalExpense = 0;

      for (var expense in expenses) {
        if (expense['isIncome'] == true) {
          totalIncome += (expense['amount'] as num).toDouble();
        } else {
          totalExpense += (expense['amount'] as num).toDouble();
        }
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª JSON Ù…Ù†Ø¸Ù…Ø©
      final exportData = {
        'appName': 'ØªØ·Ø¨ÙŠÙ‚ Ù…Ø§Ù„ÙŠ',
        'exportDate': DateTime.now().toIso8601String(),
        'exportDateFormatted': _formatDate(DateTime.now()),
        'statistics': {
          'totalTransactions': expenses.length,
          'totalIncome': totalIncome,
          'totalExpense': totalExpense,
          'balance': totalIncome - totalExpense,
        },
        'transactions': expenses,
      };

      // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ JSON
      final jsonString = jsonEncode(exportData);
      final prettyJson = JsonEncoder.withIndent('  ').convert(exportData);

      // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
      final directory = await getTemporaryDirectory();
      final timestamp = DateTime.now().millisecondsSinceEpoch;
      final fileName = 'Ù…Ø§Ù„ÙŠ_ØªØµØ¯ÙŠØ±_$timestamp.json';
      final file = File('${directory.path}/$fileName');
      await file.writeAsString(prettyJson, flush: true);

      // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù
      await Share.shareXFiles(
        [XFile(file.path)],
        subject: 'ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª JSON',
        text: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø¨ØµÙŠØºØ© JSON',
      );

      print('âœ… JSON export successful: ${file.path}');
    } catch (e) {
      print('âŒ JSON export error: $e');
      rethrow;
    }
  }

  // âœ… Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
  static String _formatDate(DateTime date) {
    return DateFormat('yyyy/MM/dd HH:mm', 'ar').format(date);
  }

  // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØµØ¯Ø±Ø©
  static Future<List<FileSystemEntity>> getExportFiles() async {
    try {
      final directory = await getTemporaryDirectory();
      final files = Directory(directory.path)
          .listSync()
          .where((entity) =>
              entity.path.contains('Ù…Ø§Ù„ÙŠ_ØªØµØ¯ÙŠØ±_') &&
              (entity.path.endsWith('.csv') || entity.path.endsWith('.json')))
          .toList();

      // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
      files.sort(
          (a, b) => b.statSync().modified.compareTo(a.statSync().modified));

      return files;
    } catch (e) {
      print('Error getting export files: $e');
      return [];
    }
  }

  // âœ… Ù…Ø³Ø­ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØµØ¯Ø±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  static Future<void> cleanOldExports({int keepLastDays = 7}) async {
    try {
      final files = await getExportFiles();
      final cutoffDate = DateTime.now().subtract(Duration(days: keepLastDays));

      for (var file in files) {
        final stat = file.statSync();
        if (stat.modified.isBefore(cutoffDate)) {
          await file.delete();
          print('ğŸ—‘ï¸ Deleted old export: ${file.path}');
        }
      }
    } catch (e) {
      print('Error cleaning old exports: $e');
    }
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\search\presentation\controllers\expense_search_controller.dart ===== 
// lib/features/search/presentation/controllers/expense_search_controller.dart

import 'package:get/get.dart';
import '../../../expense/presentation/controllers/expense_controller.dart';
import '../../../expense/domain/entities/expense_entity.dart'; // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
import '../../../../core/utils/error_handler.dart';

class ExpenseSearchController extends GetxController {
  static const String TAG = 'ExpenseSearchController';

  final searchQuery = ''.obs;
  final selectedCategory = 'Ø§Ù„ÙƒÙ„'.obs;
  final selectedType = 'Ø§Ù„ÙƒÙ„'.obs;
  final minAmount = 0.0.obs;
  final maxAmount = 1000000.0.obs;
  final startDate = Rx<DateTime?>(null);
  final endDate = Rx<DateTime?>(null);
  final isFilterActive = false.obs;

  @override
  void onInit() {
    super.onInit();
    ever(searchQuery, (_) => updateFilterStatus());
    ever(selectedCategory, (_) => updateFilterStatus());
    ever(selectedType, (_) => updateFilterStatus());
    ever(minAmount, (_) => updateFilterStatus());
    ever(maxAmount, (_) => updateFilterStatus());
    ever(startDate, (_) => updateFilterStatus());
    ever(endDate, (_) => updateFilterStatus());
  }

  void updateFilterStatus() {
    isFilterActive.value = searchQuery.value.isNotEmpty ||
        selectedCategory.value != 'Ø§Ù„ÙƒÙ„' ||
        selectedType.value != 'Ø§Ù„ÙƒÙ„' ||
        minAmount.value > 0.0 ||
        maxAmount.value < 1000000.0 ||
        startDate.value != null ||
        endDate.value != null;
  }

  List<Map<String, dynamic>> get filteredExpenses {
    try {
      final expenseController = Get.find<ExpenseController>();

      // Ø§Ù„Ø­Ù„: ØªØ­ÙˆÙŠÙ„ List<ExpenseEntity> Ø¥Ù„Ù‰ List<Map<String, dynamic>>
      List<Map<String, dynamic>> expenses = expenseController.expenses
          .map((expenseEntity) => expenseEntity.toMap())
          .toList();

      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù†Øµ
      if (searchQuery.value.isNotEmpty) {
        expenses = expenses.where((expense) {
          return expense['category']
                  .toString()
                  .toLowerCase()
                  .contains(searchQuery.value.toLowerCase()) ||
              expense['description']
                  .toString()
                  .toLowerCase()
                  .contains(searchQuery.value.toLowerCase());
        }).toList();
      }

      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ÙØ¦Ø©
      if (selectedCategory.value != 'Ø§Ù„ÙƒÙ„') {
        expenses = expenses.where((expense) {
          return expense['category'] == selectedCategory.value;
        }).toList();
      }

      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù†ÙˆØ¹
      if (selectedType.value != 'Ø§Ù„ÙƒÙ„') {
        expenses = expenses.where((expense) {
          if (selectedType.value == 'Ø¯Ø®Ù„') return expense['isIncome'] == true;
          if (selectedType.value == 'Ù…ØµØ±ÙˆÙ')
            return expense['isIncome'] == false;
          return true;
        }).toList();
      }

      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù…Ø¨Ù„Øº
      expenses = expenses.where((expense) {
        final amount = (expense['amount'] as num).toDouble();
        return amount >= minAmount.value && amount <= maxAmount.value;
      }).toList();

      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
      if (startDate.value != null) {
        expenses = expenses.where((expense) {
          try {
            final expenseDate = DateTime.parse(expense['date']);
            return expenseDate.isAfter(startDate.value!);
          } catch (e) {
            return false;
          }
        }).toList();
      }

      if (endDate.value != null) {
        expenses = expenses.where((expense) {
          try {
            final expenseDate = DateTime.parse(expense['date']);
            return expenseDate.isBefore(endDate.value!);
          } catch (e) {
            return false;
          }
        }).toList();
      }

      // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
      expenses.sort((a, b) {
        try {
          final dateA = DateTime.parse(a['date']);
          final dateB = DateTime.parse(b['date']);
          return dateB.compareTo(dateA);
        } catch (e) {
          return 0;
        }
      });

      return expenses;
    } catch (e) {
      ErrorHandler.showError('Ø®Ø·Ø£ ÙÙŠ ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: $e');
      return [];
    }
  }

  // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ExpenseEntity Ù…Ø¨Ø§Ø´Ø±Ø©
  List<ExpenseEntity> get filteredExpenseEntities {
    try {
      final expenseController = Get.find<ExpenseController>();
      List<ExpenseEntity> expenses = List.from(expenseController.expenses);

      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù†Øµ
      if (searchQuery.value.isNotEmpty) {
        expenses = expenses.where((expense) {
          return expense.category.arabicName
                  .toLowerCase()
                  .contains(searchQuery.value.toLowerCase()) ||
              expense.description
                  .toLowerCase()
                  .contains(searchQuery.value.toLowerCase());
        }).toList();
      }

      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ÙØ¦Ø©
      if (selectedCategory.value != 'Ø§Ù„ÙƒÙ„') {
        expenses = expenses.where((expense) {
          return expense.category.arabicName == selectedCategory.value;
        }).toList();
      }

      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù†ÙˆØ¹
      if (selectedType.value != 'Ø§Ù„ÙƒÙ„') {
        expenses = expenses.where((expense) {
          if (selectedType.value == 'Ø¯Ø®Ù„') return expense.isIncome == true;
          if (selectedType.value == 'Ù…ØµØ±ÙˆÙ') return expense.isIncome == false;
          return true;
        }).toList();
      }

      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù…Ø¨Ù„Øº
      expenses = expenses.where((expense) {
        return expense.amount >= minAmount.value &&
            expense.amount <= maxAmount.value;
      }).toList();

      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
      if (startDate.value != null) {
        expenses = expenses.where((expense) {
          return expense.date.isAfter(startDate.value!);
        }).toList();
      }

      if (endDate.value != null) {
        expenses = expenses.where((expense) {
          return expense.date.isBefore(endDate.value!);
        }).toList();
      }

      // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
      expenses.sort((a, b) => b.date.compareTo(a.date));

      return expenses;
    } catch (e) {
      ErrorHandler.showError('Ø®Ø·Ø£ ÙÙŠ ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: $e');
      return [];
    }
  }

  int get filteredCount => filteredExpenses.length;

  void resetFilters() {
    searchQuery.value = '';
    selectedCategory.value = 'Ø§Ù„ÙƒÙ„';
    selectedType.value = 'Ø§Ù„ÙƒÙ„';
    minAmount.value = 0.0;
    maxAmount.value = 1000000.0;
    startDate.value = null;
    endDate.value = null;
    ErrorHandler.showSuccess('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±');
  }

  Map<String, dynamic> getFilterSummary() {
    return {
      'searchQuery': searchQuery.value,
      'category': selectedCategory.value,
      'type': selectedType.value,
      'amountRange': '${minAmount.value} - ${maxAmount.value}',
      'dateRange': startDate.value != null && endDate.value != null
          ? '${startDate.value!.toIso8601String()} to ${endDate.value!.toIso8601String()}'
          : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
      'resultCount': filteredCount,
    };
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
  List<ExpenseEntity> quickSearch(String query) {
    final expenseController = Get.find<ExpenseController>();
    return expenseController.expenses.where((expense) {
      return expense.category.arabicName.contains(query) ||
          expense.description.contains(query) ||
          expense.amount.toString().contains(query);
    }).toList();
  }
}
===== FILE: E:\My Mob Projects\3 Flutter abo hamza\demos\finance_app\lib\features\search\presentation\pages\filter_page.dart ===== 
// lib/features/search/presentation/pages/filter_page.dart  :

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:intl/intl.dart';

import '../controllers/expense_search_controller.dart';
import '../../../expense/presentation/controllers/expense_controller.dart';
import '../../../../core/models/enums.dart';

class FilterPage extends StatefulWidget {
  const FilterPage({super.key});

  @override
  State<FilterPage> createState() => _FilterPageState();
}

class _FilterPageState extends State<FilterPage> {
  final ExpenseSearchController searchController =
      Get.find<ExpenseSearchController>(tag: ExpenseSearchController.TAG);
  final ExpenseController expenseController = Get.find<ExpenseController>();

  String? _selectedCategory;
  String? _selectedType;

  @override
  void initState() {
    super.initState();
    _selectedCategory = searchController.selectedCategory.value;
    _selectedType = searchController.selectedType.value;
  }

  @override
  Widget build(BuildContext context) {
    final uniqueCategories = _getUniqueCategories();
    final categories = ['Ø§Ù„ÙƒÙ„', ...uniqueCategories];
    final types = ['Ø§Ù„ÙƒÙ„', 'Ø¯Ø®Ù„', 'Ù…ØµØ±ÙˆÙ'];

    return Scaffold(
      appBar: AppBar(
        title: const Text('ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª'),
        centerTitle: true,
        actions: [
          TextButton(
            onPressed: () {
              searchController.resetFilters();
              setState(() {
                _selectedCategory = 'Ø§Ù„ÙƒÙ„';
                _selectedType = 'Ø§Ù„ÙƒÙ„';
              });
              Get.back();
            },
            child: const Text('Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†'),
          ),
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildSearchSection(),
            const SizedBox(height: 24),
            _buildFilterSection(
              'Ø§Ù„ÙØ¦Ø©',
              Icons.category,
              categories,
              _selectedCategory ?? 'Ø§Ù„ÙƒÙ„',
              (value) {
                setState(() {
                  _selectedCategory = value;
                });
                searchController.selectedCategory.value = value;
              },
            ),
            const SizedBox(height: 24),
            _buildFilterSection(
              'Ø§Ù„Ù†ÙˆØ¹',
              Icons.swap_vert,
              types,
              _selectedType ?? 'Ø§Ù„ÙƒÙ„',
              (value) {
                setState(() {
                  _selectedType = value;
                });
                searchController.selectedType.value = value;
              },
            ),
            const SizedBox(height: 24),
            _buildAmountRangeSection(),
            const SizedBox(height: 32),
            _buildResultsStats(),
            const SizedBox(height: 32),
            _buildActionButtons(),
          ],
        ),
      ),
    );
  }

  Widget _buildSearchSection() {
    return Card(
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Row(
              children: [
                Icon(Icons.search, color: Colors.blue),
                SizedBox(width: 8),
                Text(
                  'Ø§Ù„Ø¨Ø­Ø«',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),
            TextField(
              controller: TextEditingController(
                text: searchController.searchQuery.value,
              ),
              decoration: InputDecoration(
                hintText: 'Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØµÙ Ø£Ùˆ Ø§Ù„ÙØ¦Ø©...',
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
                filled: true,
                fillColor: Get.isDarkMode ? Colors.grey[800] : Colors.grey[50],
              ),
              onChanged: (value) {
                searchController.searchQuery.value = value;
              },
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildFilterSection(
    String title,
    IconData icon,
    List<String> options,
    String selectedValue,
    Function(String) onSelected,
  ) {
    return Card(
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(icon, color: Colors.blue),
                const SizedBox(width: 8),
                Text(
                  title,
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: options.map((option) {
                return ChoiceChip(
                  label: Text(option),
                  selected: selectedValue == option,
                  onSelected: (isSelected) {
                    if (isSelected) {
                      onSelected(option);
                    }
                  },
                  selectedColor: Colors.blue.withOpacity(0.2),
                  labelStyle: TextStyle(
                    color: selectedValue == option
                        ? Colors.blue
                        : Get.isDarkMode
                            ? Colors.white
                            : Colors.black,
                  ),
                );
              }).toList(),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildAmountRangeSection() {
    return Card(
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Row(
              children: [
                Icon(Icons.attach_money, color: Colors.blue),
                SizedBox(width: 8),
                Text(
                  'Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø¨Ù„Øº',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 12),
            Row(
              children: [
                Expanded(
                  child: Text(
                    'Ù…Ù†: ${searchController.minAmount.value.toInt()} Ø¬.Ù…',
                    textAlign: TextAlign.center,
                  ),
                ),
                Expanded(
                  child: Text(
                    'Ø¥Ù„Ù‰: ${searchController.maxAmount.value.toInt()} Ø¬.Ù…',
                    textAlign: TextAlign.center,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 8),
            RangeSlider(
              values: RangeValues(
                searchController.minAmount.value.clamp(0.0, 10000.0),
                searchController.maxAmount.value.clamp(0.0, 10000.0),
              ),
              min: 0,
              max: 10000,
              divisions: 100,
              onChanged: (values) {
                setState(() {
                  searchController.minAmount.value = values.start;
                  searchController.maxAmount.value = values.end;
                });
              },
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildResultsStats() {
    return Card(
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
      ),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              'Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«',
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 12),
            Obx(() {
              final filteredCount = searchController.filteredExpenses.length;
              final totalCount = expenseController.expenses.length;

              return Column(
                children: [
                  Text(
                    'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ $filteredCount Ù…Ù† Ø£ØµÙ„ $totalCount',
                    style: const TextStyle(fontSize: 14),
                  ),
                  const SizedBox(height: 8),
                  LinearProgressIndicator(
                    value: totalCount > 0 ? filteredCount / totalCount : 0,
                    backgroundColor: Colors.grey[300],
                    valueColor: AlwaysStoppedAnimation<Color>(
                      filteredCount > 0 ? Colors.green : Colors.grey,
                    ),
                  ),
                ],
              );
            }),
          ],
        ),
      ),
    );
  }

  Widget _buildActionButtons() {
    return Column(
      children: [
        SizedBox(
          width: double.infinity,
          height: 56,
          child: ElevatedButton(
            onPressed: () {
              Get.back();
            },
            child: const Text('ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©'),
            style: ElevatedButton.styleFrom(
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
          ),
        ),
        const SizedBox(height: 12),
        SizedBox(
          width: double.infinity,
          height: 56,
          child: OutlinedButton(
            onPressed: () {
              searchController.resetFilters();
              setState(() {
                _selectedCategory = 'Ø§Ù„ÙƒÙ„';
                _selectedType = 'Ø§Ù„ÙƒÙ„';
              });
              Get.back();
            },
            child: const Text('Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„'),
            style: OutlinedButton.styleFrom(
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
          ),
        ),
      ],
    );
  }

  // âœ… **Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØµØ­Ø­Ø©:**
  List<String> _getUniqueCategories() {
    final categories = <String>{};
    for (var expense in expenseController.expenses) {
      // Ø§Ù„Ø­Ù„ 1: Ø¥Ø°Ø§ ÙƒØ§Ù† expense Ù‡Ùˆ ExpenseEntity
      categories.add(expense.category.arabicName);
    }
    return categories.toList()..sort();
  }
}
